import"./index-0.0.0-dataease.js";import{E as ke}from"./el-dialog-0.0.0-dataease.js";import{j as xe,y as Ce,n as De,_ as we,e as Te}from"./index-0.0.0-dataease2.js";import{E as Ve}from"./el-input-number-0.0.0-dataease.js";import{E as Fe}from"./el-row-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{E as qe}from"./el-popover-0.0.0-dataease.js";import"./el-tooltip-0.0.0-dataease.js";import"./el-tag-0.0.0-dataease.js";import{E as Ee,a as Ne}from"./el-select-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{a as Se,E as Le}from"./el-form-item-0.0.0-dataease.js";import{d as Oe,r as C,_ as A,o as $e,a as Me,w as Y,m as Ie,f as c,M as _,N as i,k as a,i as o,j as t,ad as ee,ac as q,V as w,a6 as y,a7 as r,g as T,q as S,Z as L,aa as O,a0 as Je,n as te}from"./vue-0.0.0-dataease.js";import{i as K}from"./icon_info_outlined-0.0.0-dataease.js";import{i as ae}from"./icon_search-outline_outlined-0.0.0-dataease.js";import{i as oe}from"./icon_adjustment_outlined-0.0.0-dataease.js";import{i as Qe}from"./icon_edit_outlined-0.0.0-dataease.js";import{i as Ue}from"./icon_delete-trash_outlined-0.0.0-dataease.js";import Be from"./CodeMirror-0.0.0-dataease.js";import{F as Re}from"./dataset-0.0.0-dataease.js";import{f as k}from"./attr-0.0.0-dataease20.js";import{g as je}from"./util-0.0.0-dataease.js";import{i as $}from"./field-list-0.0.0-dataease.js";import{d as V}from"./lodash-0.0.0-dataease.js";import{E as Pe}from"./index-0.0.0-dataease4.js";import{_ as ze}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./use-dialog-0.0.0-dataease.js";import"./refs-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./user-0.0.0-dataease.js";import"./index-0.0.0-dataease15.js";import"./row-0.0.0-dataease.js";import"./dropdown-0.0.0-dataease.js";import"./index-0.0.0-dataease14.js";import"./strings-0.0.0-dataease.js";import"./index-0.0.0-dataease5.js";const Ae={class:"calcu-cont"},Ke={style:{flex:"1"}},He={style:{"max-width":"488px"}},Ze={class:"btn-select"},Ge={style:{display:"flex","align-items":"center"}},We={style:{"margin-left":"5px","font-size":"12px",color:"#8492a6"}},Xe={class:"mb8 field-exp"},Ye={key:0},et={key:1},tt={class:"padding-lr"},at={class:"mb8"},ot={class:"padding-lr-content"},lt={class:"field-height"},st={key:0,class:"field-list"},nt=["title","onClick"],it=["title"],dt={key:1,class:"class-na"},rt={class:"quota-btn_de"},ct={class:"field-height"},ut={key:0,class:"field-list"},pt=["onClick"],mt=["title"],_t={key:2,class:"icon-right"},ft={key:1,class:"class-na"},vt={class:"padding-lr"},gt={class:"mb8"},ht={key:0},yt={key:1},bt={class:"padding-lr-content"},kt={key:0,style:{width:"100%"}},xt=["onClick"],Ct={class:"pop-title"},Dt={class:"pop-info"},wt={class:"pop-info"},Tt={key:1,class:"class-na"},Vt={class:"dialog-footer"},Ft=Oe({__name:"CalcFieldEdit",props:{crossDs:{type:Boolean,default:()=>!1}},setup(le,{expose:se}){const{t:s}=xe(),H=C(),M=C(""),I=C(""),p=C(),Z=le,ne=[{label:s("dataset.text"),value:0},{label:s("dataset.time"),value:1},{label:s("dataset.value"),value:2},{label:s("dataset.value")+"("+s("dataset.float")+")",value:3},{label:s("dataset.location"),value:5},{label:"URL",value:7}],G={originName:"",name:"",groupType:"d",type:"VARCHAR",deType:0,extField:2,id:"",params:[],checked:!0},u=A({functionData:[],dimensionData:[],dimensionList:[],quotaData:[]}),J=C(),h=A({id:null,name:"",value:null}),E=C(!1),ie={name:[{required:!0,message:s("data_set.enter_parameter_name"),trigger:"blur"},{min:1,max:50,message:s("data_set.enter_1_50_characters"),trigger:"blur"}],value:[{required:!0,message:s("data_set.parameter_default_value"),trigger:"blur"}]},Q=()=>{J.value.resetFields(),E.value=!1},de=()=>{J.value.validate(n=>{if(n){h.id||(h.id=`params_${je()}`);const e=V(t(h));d.params=[e];const v=u.quotaData.find(g=>g.id===h.id);if(v){const g=p.value.state.doc.toString(),b=[];d.originName=F("name","id",g,b),Object.assign(v,V(t(h))),te(()=>{p.value.dispatch({changes:{from:0,to:p.value.viewState.state.doc.length,insert:F("id","name",d.originName)}})})}else u.quotaData.push(e);Q()}})},d=A({...G}),re=()=>{const n=p.value.state.doc.toString(),e=[];d.originName=F("name","id",n,e)},F=(n,e,v,g)=>{let b=v;const D=[...u.dimensionData,...u.quotaData].reduce((m,x)=>(m[x[n]]=x[e],m),{}),f=v.match(/\[(.+?)\]/g);return f&&f.forEach(m=>{const x=m.slice(1,-1);g&&g.push(D[x]),b=b.replace(`[${x}]`,`[${D[x]}]`)}),b};let U=[],B=[];const ce=(n,e,v)=>{if(h.id=null,Object.assign(d,{...G,...n}),u.dimensionData=e,u.quotaData=v.concat(d.params||[]),U=V(v.concat(d.params||[])),B=V(e),setTimeout(()=>{j.value.clearValidate()},100),!n.originName){p.value.dispatch({changes:{from:0,to:p.value.viewState.state.doc.length,insert:""}});return}te(()=>{p.value.dispatch({changes:{from:0,to:p.value.viewState.state.doc.length,insert:F("id","name",n.originName)}})})},W=n=>{p.value.dispatch({changes:{from:p.value.viewState.state.selection.ranges[0].from,insert:n},selection:{anchor:p.value.viewState.state.selection.ranges[0].from}})};$e(()=>{p.value=H.value.codeComInit()}),Me(()=>{var n,e;(e=(n=p.value).destroy)==null||e.call(n)});const ue=n=>{p.value.dispatch({changes:{from:p.value.viewState.state.selection.ranges[0].from,insert:n},selection:{anchor:p.value.viewState.state.selection.ranges[0].from}})};let R=[];const pe=()=>{Re().then(n=>{R=V(n),u.functionData=V(n)})};Y(()=>M.value,n=>{n&&n!==""?(u.dimensionData=JSON.parse(JSON.stringify(B.filter(e=>e.name.toLocaleLowerCase().includes(n.toLocaleLowerCase())&&e.extField===0))),u.quotaData=JSON.parse(JSON.stringify(U.filter(e=>e.name.toLocaleLowerCase().includes(n.toLocaleLowerCase())&&e.extField===0)))):(u.dimensionData=JSON.parse(JSON.stringify(B)).filter(e=>e.extField===0),u.quotaData=JSON.parse(JSON.stringify(U)).filter(e=>e.extField===0))}),Y(()=>I.value,n=>{n&&n!==""?u.functionData=JSON.parse(JSON.stringify(R.filter(e=>e.func.toLocaleLowerCase().includes(n.toLocaleLowerCase())))):u.functionData=V(R)});const j=C();se({initEdit:ce,setFieldForm:re,fieldForm:d,formField:j});const X=C(""),me=()=>{P.value||(X.value=s("data_set.add_calculation_parameters"),d.params||(d.params=[]),E.value=!0)},_e=()=>{const[n]=d.params;X.value=s("data_set.edit_calculation_parameters"),Object.assign(h,n||{}),E.value=!0},P=Ie(()=>{var n;return!!((n=d.params)!=null&&n.length)}),fe=()=>{const[n]=d.params;d.params=[];const e=p.value.state.doc.toString(),v=[];d.originName=F("name","id",e,v).replaceAll(`[${n.id}]`,""),u.quotaData=u.quotaData.filter(g=>g.id!==n.id),p.value.dispatch({changes:{from:0,to:p.value.viewState.state.doc.length,insert:F("id","name",d.originName)}})};return pe(),(n,e)=>{const v=Ce,g=Se,b=Le,D=De,f=we,m=Te,x=Ee,ve=Ne,N=Pe,ge=qe,he=Fe,ye=Ve,be=ke;return c(),_("div",{onKeydown:e[11]||(e[11]=q(()=>{},["stop"])),onKeyup:e[12]||(e[12]=q(()=>{},["stop"])),class:"calcu-field"},[i("div",Ae,[i("div",Ke,[i("div",He,[a(b,{"require-asterisk-position":"right",ref_key:"formField",ref:j,onKeydown:e[1]||(e[1]=ee(q(()=>{},["stop","prevent"]),["enter"])),model:d,"label-position":"top"},{default:o(()=>[a(g,{prop:"name",rules:[{required:!0,message:t(s)("dataset.input_edit_name")},{max:50,message:t(s)("commons.char_can_not_more_50")}],label:t(s)("dataset.field_edit_name")},{default:o(()=>[a(v,{modelValue:d.name,"onUpdate:modelValue":e[0]||(e[0]=l=>d.name=l),placeholder:t(s)("dataset.input_edit_name")},null,8,["modelValue","placeholder"])]),_:1},8,["rules","label"])]),_:1},8,["model"]),i("div",null,[a(b,{"label-position":"top",ref:"form",inline:"",model:d},{default:o(()=>[a(g,{class:"mr12",label:t(s)("dataset.data_type")},{default:o(()=>[i("div",Ze,[a(D,{onClick:e[2]||(e[2]=l=>d.groupType="d"),class:w([d.groupType==="d"&&"is-active"]),text:""},{default:o(()=>[y(r(t(s)("chart.dimension")),1)]),_:1},8,["class"]),a(D,{onClick:e[3]||(e[3]=l=>d.groupType="q"),class:w([d.groupType==="q"&&"is-active"]),text:""},{default:o(()=>[y(r(t(s)("chart.quota")),1)]),_:1},8,["class"])])]),_:1},8,["label"]),a(g,{class:"mr0",label:t(s)("dataset.field_type")},{default:o(()=>[a(ve,{modelValue:d.deType,"onUpdate:modelValue":e[4]||(e[4]=l=>d.deType=l),style:{width:"376px"}},{prefix:o(()=>[a(m,null,{default:o(()=>[a(f,null,{default:o(()=>[(c(),T(S(t($)[t(k)[d.deType]]),{class:w(["svg-icon",`field-icon-${t(k)[d.deType]}`])},null,8,["class"]))]),_:1})]),_:1})]),default:o(()=>[(c(),_(L,null,O(ne,l=>a(x,{key:l.value,label:l.label,value:l.value},{default:o(()=>[i("span",Ge,[a(m,null,{default:o(()=>[a(f,null,{default:o(()=>[(c(),T(S(t($)[t(k)[l.value]]),{class:w(["svg-icon",`field-icon-${t(k)[l.value]}`])},null,8,["class"]))]),_:2},1024)]),_:2},1024)]),i("span",We,r(l.label),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model"])]),i("div",Xe,[i("span",null,r(t(s)("dataset.field_exp")),1),e[13]||(e[13]=i("span",null,"*",-1)),a(N,{class:"item",effect:"dark",placement:"top"},{content:o(()=>[Z.crossDs?(c(),_("div",Ye,r(t(s)("dataset.calc_tips.tip1")),1)):(c(),_("div",et,r(t(s)("dataset.calc_tips.tip1_1")),1)),i("div",null,r(t(s)("dataset.calc_tips.tip2")),1)]),default:o(()=>[a(m,{size:"16px"},{default:o(()=>[a(f,{name:"icon_info_outlined"},{default:o(()=>[a(t(K),{class:"svg-icon"})]),_:1})]),_:1})]),_:1})]),a(Be,{quotaMap:u.quotaData.map(l=>l.name),dimensionMap:u.dimensionData.map(l=>l.name),ref_key:"myCm",ref:H,height:"318px","dom-id":"calcField"},null,8,["quotaMap","dimensionMap"])])]),i("div",tt,[i("span",at,[y(r(t(s)("dataset.click_ref_field"))+" ",1),a(N,{class:"item",effect:"dark",placement:"bottom"},{content:o(()=>[y(r(t(s)("dataset.calc_tips.tip3"))+" ",1),e[14]||(e[14]=i("br",null,null,-1)),y(" "+r(t(s)("dataset.calc_tips.tip4"))+" ",1),e[15]||(e[15]=i("br",null,null,-1)),y(" "+r(t(s)("dataset.calc_tips.tip5")),1)]),default:o(()=>[a(m,{size:"16px"},{default:o(()=>[a(f,{name:"icon_info_outlined"},{default:o(()=>[a(t(K),{class:"svg-icon"})]),_:1})]),_:1})]),_:1})]),i("div",ot,[a(v,{modelValue:M.value,"onUpdate:modelValue":e[5]||(e[5]=l=>M.value=l),placeholder:t(s)("dataset.edit_search"),clearable:""},{prefix:o(()=>[a(m,null,{default:o(()=>[a(f,{name:"icon_search-outline_outlined"},{default:o(()=>[a(t(ae),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["modelValue","placeholder"]),i("div",lt,[i("span",null,r(t(s)("chart.dimension")),1),u.dimensionData.length?(c(),_("div",st,[(c(!0),_(L,null,O(u.dimensionData,l=>(c(),_("span",{key:l.id,class:"item-dimension flex-align-center",title:l.name,onClick:z=>W("["+l.name+"]")},[a(m,null,{default:o(()=>[a(f,null,{default:o(()=>[(c(),T(S(t($)[t(k)[l.deType]]),{class:w(["svg-icon",`field-icon-${t(k)[l.deType]}`])},null,8,["class"]))]),_:2},1024)]),_:2},1024),i("span",{class:"ellipsis",title:l.name},r(l.name),9,it)],8,nt))),128))])):(c(),_("div",dt,r(t(s)("dataset.na")),1))]),i("div",rt,[i("span",null,r(t(s)("chart.quota")),1),a(N,{effect:"dark",content:P.value?t(s)("data_set.parameter_is_supported"):t(s)("data_set.add_calculation_parameters"),placement:"top"},{default:o(()=>[a(m,{class:"hover-icon_quota",onClick:me},{default:o(()=>[a(f,{class:w([`field-icon-${t(k)[0]}`,P.value&&"not-allow"]),style:{color:"#646a73"},name:"icon_adjustment_outlined"},{default:o(()=>[a(t(oe),{class:"svg-icon"})]),_:1},8,["class"])]),_:1})]),_:1},8,["content"])]),i("div",ct,[u.quotaData.length?(c(),_("div",ut,[(c(!0),_(L,null,O(u.quotaData,l=>(c(),_("span",{key:l.id,class:"item-quota flex-align-center",onClick:z=>W("["+l.name+"]")},[l.groupType?(c(),T(m,{key:1},{default:o(()=>[a(f,null,{default:o(()=>[(c(),T(S(t($)[t(k)[l.deType]]),{class:w(["svg-icon",`field-icon-${t(k)[l.deType]}`])},null,8,["class"]))]),_:2},1024)]),_:2},1024)):(c(),T(m,{key:0},{default:o(()=>[a(f,{name:"icon_adjustment_outlined"},{default:o(()=>[a(t(oe),{class:"svg-icon"})]),_:1})]),_:1})),i("span",{class:"ellipsis",title:l.name},r(l.name),9,mt),l.groupType?Je("",!0):(c(),_("div",_t,[a(m,{onClick:q(_e,["stop"]),class:"hover-icon"},{default:o(()=>[a(f,{name:"icon_edit_outlined"},{default:o(()=>[a(t(Qe),{class:"svg-icon"})]),_:1})]),_:1}),a(m,{onClick:q(fe,["stop"]),class:"hover-icon"},{default:o(()=>[a(f,{name:"icon_delete-trash_outlined"},{default:o(()=>[a(t(Ue),{class:"svg-icon"})]),_:1})]),_:1})]))],8,pt))),128))])):(c(),_("div",ft,r(t(s)("dataset.na")),1))])])]),i("div",vt,[i("span",gt,[y(r(t(s)("dataset.click_ref_function"))+" ",1),a(N,{class:"item",effect:"dark",placement:"bottom"},{content:o(()=>[Z.crossDs?(c(),_("div",ht,[y(r(t(s)("dataset.calc_tips.tip6"))+" ",1),e[16]||(e[16]=i("br",null,null,-1)),y(" "+r(t(s)("dataset.calc_tips.tip8"))+" ",1),e[17]||(e[17]=i("br",null,null,-1)),e[18]||(e[18]=y(" https://calcite.apache.org/docs/reference.html "))])):(c(),_("div",yt,r(t(s)("dataset.calc_tips.tip7")),1))]),default:o(()=>[a(m,{size:"16px"},{default:o(()=>[a(f,{name:"icon_info_outlined"},{default:o(()=>[a(t(K),{class:"svg-icon"})]),_:1})]),_:1})]),_:1})]),i("div",bt,[a(v,{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=l=>I.value=l),style:{"margin-bottom":"8px"},placeholder:t(s)("dataset.edit_search"),clearable:""},{prefix:o(()=>[a(m,null,{default:o(()=>[a(f,{name:"icon_search-outline_outlined"},{default:o(()=>[a(t(ae),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["modelValue","placeholder"]),a(he,{class:"function-height"},{default:o(()=>[u.functionData.length?(c(),_("div",kt,[(c(!0),_(L,null,O(u.functionData,(l,z)=>(c(),T(ge,{key:z,class:"function-pop",placement:"right",width:"200",trigger:"hover","open-delay":500},{reference:o(()=>[i("span",{class:"function-style flex-align-center",onClick:qt=>ue(l.func)},r(l.func),9,xt)]),default:o(()=>[i("p",Ct,r(l.name),1),i("p",Dt,r(l.func),1),i("p",wt,r(l.desc),1)]),_:2},1024))),128))])):(c(),_("div",Tt,r(t(s)("chart.no_function")),1))]),_:1})])])]),a(be,{"before-close":Q,modelValue:E.value,"onUpdate:modelValue":e[10]||(e[10]=l=>E.value=l),title:t(s)("data_set.add_calculation_parameters"),width:"500"},{footer:o(()=>[i("div",Vt,[a(D,{onClick:Q},{default:o(()=>[y(r(t(s)("chart.cancel")),1)]),_:1}),a(D,{type:"primary",onClick:de},{default:o(()=>[y(r(t(s)("chart.confirm")),1)]),_:1})])]),default:o(()=>[a(b,{onKeydown:e[9]||(e[9]=ee(q(()=>{},["stop","prevent"]),["enter"])),"label-position":"top",ref_key:"formQuotaRef",ref:J,model:h,rules:ie},{default:o(()=>[a(g,{label:t(s)("data_set.parameter_name"),prop:"name"},{default:o(()=>[a(v,{style:{width:"100%"},modelValue:h.name,"onUpdate:modelValue":e[7]||(e[7]=l=>h.name=l),placeholder:t(s)("data_set.enter_1_50_characters")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),a(g,{label:t(s)("data_set.parameter_default_value_de"),prop:"value"},{default:o(()=>[a(ye,{style:{width:"100%"},modelValue:h.value,"onUpdate:modelValue":e[8]||(e[8]=l=>h.value=l),placeholder:t(s)("data_set.enter_a_number"),"controls-position":"right"},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])],32)}}});const fa=ze(Ft,[["__scopeId","data-v-960f378e"]]);export{fa as default};
