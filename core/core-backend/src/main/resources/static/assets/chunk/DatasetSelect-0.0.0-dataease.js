import{a as Te,u as J,aI as Ve,ak as Ne,P as xe}from"./index-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{E as Ie}from"./el-popover-0.0.0-dataease.js";import"./el-footer-0.0.0-dataease.js";import{E as Be,b as Pe,d as Fe,c as Oe}from"./el-aside-0.0.0-dataease.js";import{E as Me}from"./el-tree-0.0.0-dataease.js";import"./el-checkbox-0.0.0-dataease.js";import{j as Ae,e as We,y as je,n as Ue,_ as ze}from"./index-0.0.0-dataease2.js";import"./el-form-0.0.0-dataease.js";import{d as He}from"./dv-folder-0.0.0-dataease.js";import{i as Le}from"./icon_dataset-0.0.0-dataease.js";import{i as Re}from"./icon_done_outlined-0.0.0-dataease.js";import{useAppStoreWithOut as $e}from"./app-0.0.0-dataease.js";import{_ as w}from"./lodash-0.0.0-dataease.js";import{l as qe,g as Ge}from"./dataset-0.0.0-dataease.js";import{a as Je,E as Ke}from"./el-form-item-0.0.0-dataease.js";import{useUserStoreWithOut as Qe}from"./user-0.0.0-dataease.js";import{d as Xe}from"./dvMain-0.0.0-dataease.js";import{t as Ye}from"./treeSortUtils-0.0.0-dataease.js";import{d as Ze,r as l,m as s,w as et,o as tt,e as K,ab as ot,f as r,M as P,k as a,i as o,j as n,V as f,g as _,a0 as c,N as C,a7 as D,a6 as F,U as at}from"./vue-0.0.0-dataease.js";import{_ as st}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./index-0.0.0-dataease4.js";import"./dropdown-0.0.0-dataease.js";import"./index-0.0.0-dataease12.js";import"./axios-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./formatter-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./util-0.0.0-dataease2.js";import"./chart-0.0.0-dataease2.js";import"./antv-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./row-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";const lt={key:0,class:"m-loading"},rt={key:1,class:"empty-info"},nt=["title"],it={class:"m-icon"},ct={class:"footer-container"},ut=Ze({__name:"DatasetSelect",props:{themes:{default:"dark"},modelValue:{},stateObj:{},disabled:{type:Boolean,default:!1},viewId:{},sourceType:{default:"dataset"}},emits:["update:modelValue","update:stateObj","onDatasetChange","addDsWindow"],setup(Q,{expose:X,emit:Y}){const O=Xe(),{wsCache:E}=Te("localStorage"),M=Qe(),v=Q,h=l(null),u=l(!1),g=l(!0),d=l([]),k=s(()=>v.sourceType==="datasource"?"数据源":"数据集"),Z=e=>{const t=E.get("TreeSort-dataset")||"time_desc";d.value=Ye(e,t)},A=()=>{u.value=!0,(v.sourceType==="datasource"?qe:Ge)({}).then(t=>{Z(t||[])}).finally(()=>{var t;u.value=!1,(t=W.value)==null||t.validate()})},b=Y,m=s({get(){return v.modelValue},set(e){b("update:modelValue",e)}}),ee={label:"name",children:"children",value:"id",isLeaf:e=>{var t;return!((t=e.children)!=null&&t.length)}},{t:T}=Ae(),W=l(),V=l();et(V,e=>{h.value.filter(e)});const N=s(()=>d.value&&d.value.length>0&&!u.value&&g.value),te=s(()=>g.value?"暂无"+k.value:"已切换至新组织，无权访问其他组织的资源"),oe=s(()=>!N.value&&!u.value&&!g.value),j=s(()=>N.value&&d.value[0].id==="0"?d.value[0].children:d.value),ae=s(()=>w.filter(H(j.value),e=>e.leaf)),U=s(()=>w.find(ae.value,e=>e.id===m.value)),z=s(()=>!(m.value&&U.value===void 0)),x=s(()=>{var e;return z.value?(e=U.value)==null?void 0:e.name:k.value+"不存在"}),se=s(()=>({name:x.value})),le=l([{validator:(...e)=>{z.value?e[2]():e[2](new Error)},trigger:["change","blur"]}]);function H(e){let t=w.cloneDeep(e);return w.forEach(e,i=>{i.children&&i.children.length>0&&(t=w.union(t,H(i.children)))}),t}const re=e=>{b("onDatasetChange",e)},ne=(e,t)=>{var i;return e?(i=t.name)==null?void 0:i.includes(e):!0},L=()=>{A()},ie=()=>{b("addDsWindow")},R=l(),$=e=>{var t;e.leaf&&(m.value!==e.id&&re(e.id),m.value=e.id,(t=R.value)==null||t.hide())},I=l(!1);function ce(){I.value=!0}function ue(){I.value=!1}function de(e){var t;return(t=h==null?void 0:h.value)==null?void 0:t.getNode(e)}const me=s(()=>v.sourceType==="dataset"&&O.curComponent&&["rich-text","picture-group"].includes(O.curComponent.innerType)),pe=e=>{e.preventDefault(),e.stopPropagation(),$({leaf:!0,id:null}),J().emitter.emit("clear-remove",["xAxis","yAxis","drillFields"])},fe=()=>{v.sourceType==="dataset"&&M.getOid&&E.get("user.oid")&&M.getOid!==E.get("user.oid")?g.value=!1:g.value=!0};X({getNode:de});const _e=$e(),ve=s(()=>_e.getIsDataEaseBi);return tt(()=>{A(),J({name:"refresh-dataset-selector",callback:()=>L()})}),(e,t)=>{const i=K("ArrowDown"),y=We,he=K("CircleClose"),q=je,ge=Ke,G=Ue,ke=Be,B=ze,ye=Me,we=xe,Ce=Pe,De=Fe,Se=Oe,Ee=Ie,be=ot("loading");return r(),P("div",null,[a(Ee,{ref_key:"datasetSelectorPopover",ref:R,trigger:"click",placement:"bottom-start",width:320,"popper-class":"customDatasetSelect","show-arrow":!1,onShow:ce,onHide:ue,effect:e.themes,offset:4},{reference:o(()=>[a(ge,{ref_key:"formRef",ref:W,model:se.value},{default:o(()=>[a(n(Je),{prop:"name",rules:le.value},{default:o(()=>[a(q,{size:"middle",effect:e.themes,modelValue:x.value,"onUpdate:modelValue":t[0]||(t[0]=p=>x.value=p),class:"data-set-dark",onFocus:fe,disabled:e.disabled,placeholder:n(T)("common.selectText")+k.value},{suffix:o(()=>[a(y,{class:f(["input-arrow-icon",{reverse:I.value}])},{default:o(()=>[a(i)]),_:1},8,["class"]),me.value?(r(),_(y,{key:0,class:"input-custom-clear-icon",onClick:pe},{default:o(()=>[a(he)]),_:1})):c("",!0)]),_:1},8,["effect","modelValue","disabled","placeholder"])]),_:1},8,["rules"])]),_:1},8,["model"])]),default:o(()=>[a(Se,{class:f(e.themes)},{default:o(()=>[a(ke,null,{default:o(()=>[C("div",{class:f(["m-title",{dark:e.themes==="dark"}])},[C("div",null,D(k.value),1),a(G,{type:"primary",link:"",class:"refresh-btn",onClick:L},{default:o(()=>[F(D(n(T)("commons.refresh")),1)]),_:1})],2),a(q,{size:"middle",effect:e.themes,modelValue:V.value,"onUpdate:modelValue":t[1]||(t[1]=p=>V.value=p),placeholder:n(T)("dataset.search"),"prefix-icon":n(Ve),clearable:""},null,8,["effect","modelValue","placeholder","prefix-icon"])]),_:1}),a(Ce,{class:f({dark:e.themes==="dark"})},{default:o(()=>[a(we,{"max-height":"252px",always:""},{default:o(()=>[u.value?at((r(),P("div",lt,null,512)),[[be,u.value]]):c("",!0),oe.value?(r(),P("div",rt,D(te.value),1)):c("",!0),N.value?(r(),_(ye,{key:2,class:f({dark:e.themes==="dark"}),ref_key:"datasetSelector",ref:h,"node-key":"id",data:j.value,teleported:!1,props:ee,"render-after-expand":!1,filterable:"",onNodeClick:$,"filter-node-method":ne,"empty-text":"暂无相关数据"},{default:o(({node:p,data:S})=>[C("div",{class:f(["tree-row-item",{dark:e.themes==="dark",active:m.value===S.id}]),title:p.label},[C("div",it,[S.leaf?c("",!0):(r(),_(y,{key:0},{default:o(()=>[a(B,{name:"dv-folder"},{default:o(()=>[a(n(He),{class:"svg-icon"})]),_:1})]),_:1})),S.leaf?(r(),_(y,{key:1},{default:o(()=>[a(B,{name:"icon_dataset"},{default:o(()=>[a(n(Le),{class:"svg-icon"})]),_:1})]),_:1})):c("",!0)]),F(" "+D(p.label)+" ",1),m.value===S.id?(r(),_(y,{key:0,class:"checked-item"},{default:o(()=>[a(B,{name:"icon_done_outlined"},{default:o(()=>[a(n(Re),{class:"svg-icon"})]),_:1})]),_:1})):c("",!0)],10,nt)]),_:1},8,["class","data"])):c("",!0)]),_:1})]),_:1},8,["class"]),ve.value?c("",!0):(r(),_(De,{key:0},{default:o(()=>[C("div",ct,[a(G,{type:"primary",icon:n(Ne),link:"",class:"add-btn",onClick:ie},{default:o(()=>[F(" 新建"+D(k.value),1)]),_:1},8,["icon"])])]),_:1}))]),_:1},8,["class"])]),_:1},8,["effect"])])}}});const to=st(ut,[["__scopeId","data-v-2d7fe22f"]]);export{to as default};
