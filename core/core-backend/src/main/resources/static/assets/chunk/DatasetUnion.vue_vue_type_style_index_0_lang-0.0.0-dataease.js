import{p as Z}from"./index-0.0.0-dataease.js";import{E as vt}from"./el-drawer-0.0.0-dataease.js";import{j as pt,x as $e,_ as gt,e as Ct,y as _t,n as Nt}from"./index-0.0.0-dataease2.js";import{E as wt}from"./el-dialog-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{a as yt,E as Lt}from"./el-form-item-0.0.0-dataease.js";import{i as bt}from"./icon_edit_outlined-0.0.0-dataease.js";import{i as xt}from"./icon_rename_outlined-0.0.0-dataease.js";import{i as St}from"./icon_delete-trash_outlined-0.0.0-dataease.js";import{i as Ft,r as kt,A as Dt}from"./AddSql-0.0.0-dataease.js";import{i as Mt,a as qt,b as Vt,c as Et}from"./icon_right-association-0.0.0-dataease.js";import{f as N,M as b,N as m,d as It,_ as Be,m as $,r as y,w as $t,Z as z,aa as se,V as He,a0 as W,j as p,a7 as L,W as Pe,k as C,i as _,aw as Bt,n as D,R as Ht,g as le,q as Oe,a6 as G}from"./vue-0.0.0-dataease.js";import{g as K}from"./util-0.0.0-dataease.js";import{_ as Pt}from"./HandleMore.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import Ot from"./UnionFieldList-0.0.0-dataease.js";import{K as Q}from"./dataset-0.0.0-dataease.js";import{useAppearanceStoreWithOut as At}from"./appearance-0.0.0-dataease.js";import{d as P}from"./lodash-0.0.0-dataease.js";const Tt={width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function Ut(M,q){return N(),b("svg",Tt,q[0]||(q[0]=[m("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M3.45675 1H17.6731C17.9005 1 18.1185 1.09031 18.2792 1.25105L21.2057 4.17752C21.3664 4.33827 21.4567 4.55628 21.4567 4.78361V22.1429C21.4567 22.6162 21.073 23 20.5996 23H3.45675C2.98336 23 2.59961 22.6162 2.59961 22.1429V1.85714C2.59961 1.38376 2.98336 1 3.45675 1ZM4.65671 20.943H19.3996V6.14286H16.6139C16.4482 6.14286 16.3139 6.00854 16.3139 5.84286V3.05728H4.65671V20.943Z",fill:"#1F2329"},null,-1),m("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M7.14301 15.1995C7.62115 15.3448 7.88838 15.4368 7.97097 15.4779C8.20814 15.5993 8.29661 15.742 8.29661 15.908C8.29661 16.0368 8.23821 16.1411 8.08507 16.2273C7.92199 16.319 7.69145 16.376 7.38461 16.376C7.03826 16.376 6.81324 16.3116 6.67727 16.2085C6.52902 16.0973 6.42001 15.8951 6.3751 15.5808L6.3567 15.452H5.41828L5.42894 15.612C5.46708 16.1841 5.67363 16.6275 6.07362 16.9122L6.0751 16.9132C6.40233 17.1403 6.8437 17.252 7.38461 17.252C7.94221 17.252 8.39741 17.1408 8.73225 16.8997L8.73384 16.8986C9.07299 16.6476 9.24461 16.3024 9.24461 15.872C9.24461 15.4174 9.02564 15.0656 8.6204 14.8197C8.43354 14.7063 8.03615 14.5632 7.46535 14.3848L7.46351 14.3843C7.05814 14.2633 6.82897 14.1775 6.75017 14.1332L6.74662 14.1313C6.65345 14.0822 6.59505 14.0305 6.55989 13.9798C6.52594 13.9308 6.50861 13.8755 6.50861 13.808C6.50861 13.721 6.52658 13.6555 6.55624 13.6049C6.58562 13.5548 6.63188 13.5103 6.70345 13.4734L6.7079 13.4709C6.8255 13.405 7.01164 13.364 7.28261 13.364C7.59144 13.364 7.79362 13.4218 7.92458 13.52L7.92742 13.5221C8.05293 13.6117 8.14805 13.7744 8.20403 14.0319L8.22971 14.15H9.16267L9.14801 13.9866C9.10333 13.4887 8.92145 13.1022 8.57883 12.8482C8.26107 12.6052 7.83431 12.5 7.31861 12.5C6.84027 12.5 6.43085 12.6072 6.10026 12.832C5.74169 13.0755 5.56061 13.4157 5.56061 13.844C5.56061 14.2695 5.75086 14.606 6.12537 14.8307L6.13078 14.8337C6.27846 14.9142 6.6191 15.0329 7.14112 15.199L7.14301 15.1995ZM6.16092 16.79C5.80692 16.538 5.61492 16.142 5.57892 15.602C5.58234 15.6533 5.58686 15.7033 5.5931 15.752C5.65255 16.2159 5.84055 16.5619 6.16092 16.79Z",fill:"#1F2329"},null,-1),m("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M12.0994 17.252C12.5126 17.252 12.8785 17.1726 13.1969 17.0093C13.3257 17.1858 13.4555 17.371 13.59 17.5654L13.6863 17.7044L14.3319 17.1325L14.2572 17.0233C14.1225 16.8264 13.9834 16.6385 13.8491 16.4577C14.1734 16.0329 14.3314 15.5059 14.3314 14.882C14.3314 14.194 14.1431 13.6216 13.7533 13.1862C13.3423 12.7231 12.7827 12.5 12.0994 12.5C11.4106 12.5 10.8499 12.7228 10.4443 13.1934C10.0553 13.6347 9.87337 14.2005 9.87337 14.882C9.87337 15.558 10.0558 16.1243 10.4451 16.5655C10.8498 17.0224 11.4093 17.252 12.0994 17.252ZM13.7136 17.4798C13.5516 17.2459 13.3956 17.024 13.2397 16.814C13.3678 16.9865 13.4958 17.1672 13.6272 17.3559L13.7136 17.4798ZM12.2257 15.596C12.4357 15.818 12.6517 16.064 12.8677 16.334C12.6577 16.46 12.3997 16.526 12.0997 16.526C12.3378 16.526 12.5492 16.4844 12.7314 16.4042C12.7787 16.3834 12.8244 16.36 12.8677 16.334C12.8358 16.2942 12.8037 16.2549 12.7718 16.2161C12.5878 15.992 12.4047 15.7853 12.2257 15.596ZM13.2515 15.9498C13.4315 15.6738 13.5217 15.32 13.5217 14.882C13.5217 15.2502 13.4578 15.559 13.3306 15.812C13.3065 15.8599 13.2802 15.9059 13.2515 15.9498ZM12.1164 15.6991C12.2856 15.8779 12.4587 16.0725 12.6326 16.283C12.4803 16.3434 12.3026 16.376 12.0994 16.376C11.6817 16.376 11.3725 16.2353 11.1529 15.9743C10.9412 15.7145 10.8274 15.3558 10.8274 14.882C10.8274 14.4014 10.9421 14.042 11.1541 13.7823C11.3725 13.5118 11.68 13.376 12.0994 13.376C12.5213 13.376 12.8281 13.5075 13.0393 13.765C13.2515 14.0251 13.3714 14.3902 13.3714 14.882C13.3714 15.2046 13.3202 15.4707 13.2234 15.6879C13.0536 15.4923 12.8832 15.3012 12.7123 15.1208L12.6071 15.0099L12.0153 15.5922L12.1164 15.6991Z",fill:"#1F2329"},null,-1),m("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M16.142 12.584H15.194V17.168H18.5V16.31H16.142V12.584Z",fill:"#1F2329"},null,-1)]))}const Yt={render:Ut},Zt={width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function jt(M,q){return N(),b("svg",Zt,q[0]||(q[0]=[m("g",{id:"icon_more-vertical_outlined"},[m("path",{id:"Vector",d:"M9 12.0002V13.3335C9 13.3773 8.99138 13.4206 8.97463 13.4611C8.95788 13.5015 8.93332 13.5382 8.90237 13.5692C8.87142 13.6002 8.83467 13.6247 8.79423 13.6415C8.75379 13.6582 8.71044 13.6668 8.66667 13.6668H7.33333C7.28956 13.6668 7.24621 13.6582 7.20577 13.6415C7.16533 13.6247 7.12858 13.6002 7.09763 13.5692C7.06668 13.5382 7.04213 13.5015 7.02537 13.4611C7.00862 13.4206 7 13.3773 7 13.3335V12.0002C7 11.9118 7.03512 11.827 7.09763 11.7645C7.16014 11.7019 7.24493 11.6668 7.33333 11.6668H8.66667C8.71044 11.6668 8.75379 11.6755 8.79423 11.6922C8.83467 11.709 8.87142 11.7335 8.90237 11.7645C8.93332 11.7954 8.95788 11.8322 8.97463 11.8726C8.99138 11.913 9 11.9564 9 12.0002ZM9 2.66683V4.00016C9 4.04394 8.99138 4.08728 8.97463 4.12772C8.95788 4.16817 8.93332 4.20491 8.90237 4.23587C8.87142 4.26682 8.83467 4.29137 8.79423 4.30812C8.75379 4.32487 8.71044 4.3335 8.66667 4.3335H7.33333C7.24493 4.3335 7.16014 4.29838 7.09763 4.23587C7.03512 4.17335 7 4.08857 7 4.00016V2.66683C7 2.62306 7.00862 2.57971 7.02537 2.53927C7.04213 2.49883 7.06668 2.46208 7.09763 2.43113C7.12858 2.40017 7.16533 2.37562 7.20577 2.35887C7.24621 2.34212 7.28956 2.3335 7.33333 2.3335H8.66667C8.71044 2.3335 8.75379 2.34212 8.79423 2.35887C8.83467 2.37562 8.87142 2.40017 8.90237 2.43113C8.93332 2.46208 8.95788 2.49883 8.97463 2.53927C8.99138 2.57971 9 2.62306 9 2.66683ZM9 7.3335V8.66683C9 8.7106 8.99138 8.75395 8.97463 8.79439C8.95788 8.83483 8.93332 8.87158 8.90237 8.90253C8.87142 8.93349 8.83467 8.95804 8.79423 8.97479C8.75379 8.99154 8.71044 9.00016 8.66667 9.00016H7.33333C7.28956 9.00016 7.24621 8.99154 7.20577 8.97479C7.16533 8.95804 7.12858 8.93349 7.09763 8.90253C7.06668 8.87158 7.04213 8.83483 7.02537 8.79439C7.00862 8.75395 7 8.7106 7 8.66683V7.3335C7 7.24509 7.03512 7.16031 7.09763 7.09779C7.16014 7.03528 7.24493 7.00016 7.33333 7.00016H8.66667C8.71044 7.00016 8.75379 7.00879 8.79423 7.02554C8.83467 7.04229 8.87142 7.06684 8.90237 7.09779C8.93332 7.12875 8.95788 7.16549 8.97463 7.20594C8.99138 7.24638 9 7.28972 9 7.3335Z",fill:"#1F2329"})],-1)]))}const Xt={render:jt},Jt=""+new URL("../png/drag-0.0.0-dataease.png",import.meta.url).href,Rt=["width","height"],zt=["d","stroke-dasharray","stroke"],Wt=["x","y"],Gt=["onClick"],Kt={class:"tableName"},Qt={class:"placeholder"},ea=["x","y"],ta=["onClick"],aa={key:1,class:"zero"},na=["src"],oa={class:"dialog-footer"},sa={class:"info-content"},la={class:"info"},ia={class:"label"},da=["title"],ra={class:"info"},ca={class:"label"},ua=["title"],fa=["title"],Va=It({__name:"DatasetUnion",props:{maskShow:Z.bool.def(!1),offsetX:Z.number.def(0),offsetY:Z.number.def(0),dragHeight:Z.number.def(260),getDsName:Z.func},emits:["addComplete","joinEditor","updateAllfields","changeUpdate","reGetName"],setup(M,{expose:q,emit:Ae}){const ie=At(),o=Be({nodeList:[],visualNode:null,visualNodeParent:null,visualPath:null}),de=M,Te=$(()=>ie.themeColor==="custom"?ie.customColor:"#3370FF"),Ue={left:Mt,right:qt,inner:Vt,full:Et},{t:f}=pt(),V=y(!1),x=y([]),h=y(),j=y(),O=Ht("allfields"),Ye=({datasourceId:e,id:t,info:a,tableName:n,type:l,currentDsFields:i})=>Q({datasourceId:e,id:t,info:a,tableName:n,type:l}).then(r=>{const c=O.value.reduce((d,u)=>(d[`${u.datasetTableId}${u.originName}`]=u.id,d),{});x.value=r,x.value.forEach(d=>{d.id=c[`${t}${d.originName}`],d.checked=i.map(u=>u.originName).includes(d.originName)})}).finally(()=>{B.value=!0}),Ze=$(()=>{const e=[];return ce(o.nodeList,e),e}),re=y(),je=e=>{e.target===re.value&&(ee.value="")},ee=y("");let E=0,I=0;const Xe=()=>{he.value=`${E*100+(E+1)*200+48}px`,me.value=`${I*24+(I+1)*32+48}px`},te=$(()=>{let e=[];return E=0,I=0,ke(o.nodeList,e),Xe(),e}),ce=(e,t)=>{e.forEach(a=>{var n;t.push(`${a.tableName}${a.datasourceId}`),(n=a.children)!=null&&n.length&&ce(a.children,t)})},ue=(e,t)=>e.every(a=>{var n;return(n=a.children)!=null&&n.length?ue(a.children,t):a.datasourceId?a.datasourceId===t:!0}),Je=$(()=>{const{datasourceId:e,children:t=[]}=o.nodeList[0]||{};return e&&t.length?!ue(t,e):!1});let fe=!1;$t(()=>o.nodeList,()=>{fe&&g("changeUpdate")},{deep:!0});const Re=e=>{Object.assign(o.nodeList,e),D(()=>{fe=!0,g("addComplete")})},B=y(!1),he=y("200px"),me=y("260px"),ae=(e,t)=>{t.some((a,n)=>{var l;return e===a.id?(t.splice(n,1),!0):((l=a.children)!=null&&l.length&&ae(e,a.children),!1)})};let F=[];const ve=e=>{e.forEach(t=>{var a;F=[...F,...t.currentDsFields.map(n=>n.id)],(a=t.children)!=null&&a.length&&ve(t.children)})},pe=(e,t)=>{t.forEach(a=>{var n,l;e===a.id?(F=[...a.currentDsFields.map(i=>i.id)],(n=a.children)!=null&&n.length&&ve(a.children)):(l=a.children)!=null&&l.length&&pe(e,a.children)})},H=y([]),A=y([]),ze=(e,t)=>{const{tableName:a,id:n,sql:l,datasourceId:i,sqlVariableDetails:r=null,changeFlag:c=!1}=e;if(c&&(A.value=A.value.filter(u=>u.from!==n&&n!==u.to),!H.value.includes(n)&&H.value.push(n)),o.visualNode){Object.assign(o.visualNode,{info:JSON.stringify({table:a,sql:l}),sqlVariableDetails:r,unionType:"left",type:"sql",id:n,datasourceId:i,unionFields:[],currentDsFields:[]}),o.visualNode.confirm=!0,o.nodeList.length||(o.visualNode.tableName=a,o.nodeList.push(o.visualNode),h.value=o.nodeList[0],Q({datasourceId:i,id:n,info:o.visualNode.info,tableName:a,type:"sql"}).then(u=>{x.value=u,x.value.forEach(s=>{s.checked=!0}),o.nodeList[0].currentDsFields=P(u),t==null||t(),Ce()}),J());return}const d={info:JSON.stringify({table:a,sql:l}),id:n,tableName:a,sqlVariableDetails:r};oe([d],[n],o.nodeList),g("reGetName")},We=(e,t)=>{A.value.some(a=>a.from===t&&a.to===e)||A.value.push({from:t,to:e})},Ge=()=>{var e,t;if(o.nodeList.length===1&&!((e=o.nodeList[0].children)!=null&&e.length)&&H.value.length===1){h.value=o.nodeList[0];const{datasourceId:a,id:n,info:l,tableName:i}=h.value;Q({datasourceId:a,id:n,info:l,tableName:i,type:"sql"}).then(r=>{const c=O.value.reduce((d,u)=>(d[`${u.datasetTableId}${u.originName}`]=u.id,d),{});x.value=r,x.value.forEach(d=>{d.id=c[`${n}${d.originName}`],d.checked=!0}),o.nodeList[0].currentDsFields=P(r),B.value=!0}),H.value=[]}if((t=o.visualNode)!=null&&t.confirm){D(()=>{g("joinEditor",[{...o.visualNode,tableName:JSON.parse(o.visualNode.info).table},o.visualNodeParent])}),V.value=!1;return}if(V.value=!1,!o.visualNodeParent){o.visualNode=null;return}o.visualNodeParent.children=o.visualNodeParent.children.filter(a=>!a.isShadow),J()},Ke=e=>{h.value.currentDsFields=e},X=()=>{x.value=[],h.value=null;const[e]=o.nodeList;e.isShadow&&(delete e.isShadow,o.nodeList=[],g("addComplete")),B.value=!1};let Qe=+new Date;const et=(e,t,a)=>{e.forEach(n=>{n.id||(n.id=`${++Qe}`,n.datasetTableId=t,n.datasourceId=a)})},ne=(e,t)=>{t.some(a=>{var n;return e===a.id?(et(h.value.currentDsFields,a.id,a.datasourceId),a.currentDsFields=h.value.currentDsFields,!0):((n=a.children)!=null&&n.length&&ne(e,a.children),!1)})},ge=(e,t)=>{t.forEach(a=>{var n;e===a.id&&(F=[...a.currentDsFields.map(l=>l.id)]),(n=a.children)!=null&&n.length&&ge(e,a.children)})},Ce=()=>{ge(h.value.id,o.nodeList);const e=h.value.currentDsFields.map(n=>n.id);let t=F.filter(n=>!e.includes(n));if(F=[],t.length){const n=O.value.reduce((l,i)=>{if(i.extField===2){let r=i.originName.match(/\[(.+?)\]/g);r=r.filter(d=>{var u;return!((u=i.params)!=null&&u.map(s=>s.id).includes(d.slice(1,-1)))}),r.map(d=>d.slice(1,-1)).forEach(d=>{t.includes(d)&&l.push(d)})}return l},[]);if(n.length){$e.confirm(f("data_set.field_selection"),{confirmButtonText:f("dataset.confirm"),cancelButtonText:f("common.cancel"),showCancelButton:!0,tip:`${f("data_set.field")}: ${O.value.filter(l=>[...new Set(n)].includes(l.id)&&l.extField!==2).map(l=>l.name).join(",")}, ${f("data_set.confirm_the_deletion")}`,confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1,callback:l=>{if(l==="confirm"){ne(h.value.id,o.nodeList);const[i]=o.nodeList;i.isShadow&&delete i.isShadow,X(),D(()=>{g("updateAllfields")})}}});return}}ne(h.value.id,o.nodeList);const[a]=o.nodeList;a.isShadow&&delete a.isShadow,X(),D(()=>{g("updateAllfields")})},_e=(e,t)=>{if(t==="editerField"&&(Ye(e),h.value=P(e)),t==="rename"&&ft({name:e.tableName,id:e.id}),t==="editerSql"){const{tableName:a,datasourceId:n,info:l,id:i,sqlVariableDetails:r}=e;if(e.type==="sql"){j.value={sql:(JSON.parse(l)||{}).sql,tableName:a,id:i,variables:JSON.parse(r),datasourceId:n},V.value=!0;return}}if(t==="del"){if(pe(e.id,o.nodeList),F.length){const a=O.value.reduce((n,l)=>(l.extField===2&&l.originName.match(/\[(.+?)\]/g).map(c=>c.slice(1,-1)).forEach(c=>{F.includes(c)&&n.push(c)}),n),[]);if(F=[],a.length){$e.confirm(f("data_set.confirm_to_delete",{a:e.tableName}),{confirmButtonText:f("dataset.confirm"),cancelButtonText:f("common.cancel"),showCancelButton:!0,tip:f("data_set.also_be_deleted"),confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1,callback:n=>{n==="confirm"&&(ae(e.id,o.nodeList),D(()=>{g("addComplete"),g("updateAllfields")}))}});return}}ae(e.id,o.nodeList),D(()=>{g("addComplete"),g("updateAllfields")})}},tt=e=>{const{from:t,to:a}=e,n=[],l=[t.id,a.id];Ne(n,l,o.nodeList),g("joinEditor",n)},Ne=(e,t,a)=>{a.forEach(n=>{var l;t.includes(n.id)&&e.unshift(n),(l=n.children)!=null&&l.length&&Ne(e,t,n.children)})},oe=(e,t,a)=>{a.forEach(n=>{var l;if(t.includes(n.id)){t.shift();const i=e.shift();Object.assign(n,i)}(l=n.children)!=null&&l.length&&oe(e,t,n.children)})},we=(e,{originName:t,datasetTableId:a})=>{e.forEach(n=>{var l;if(a===n.id){const i=n.currentDsFields.filter(r=>r.originName!==t);n.currentDsFields=i}(l=n.children)!=null&&l.length&&we(n.children,{originName:t,datasetTableId:a})})},at=e=>{we(o.nodeList,e)},ye=[{svgName:Ft,label:f("data_set.field_selection"),command:"editerField"},{svgName:St,label:f("data_set.delete"),command:"del"}],nt=[{svgName:bt,label:f("data_set.edit_sql"),command:"editerSql"},{svgName:xt,label:f("datasource.field_rename"),command:"rename"}],T=y(0),U=y(0);function Le(e,t){const a=e.right-e.left,n=e.bottom-e.top,l=t.right-t.left,i=t.bottom-t.top,r=a+l-(Math.max(e.right,t.right)-Math.min(e.left,t.left)),c=n+i-(Math.max(e.bottom,t.bottom)-Math.min(e.top,t.top));return r<=0||c<=0?0:r*c}const be=$(()=>{let e=[];return xe(te.value,e),e.filter(t=>!t.isShadow)}),xe=(e,t)=>{e.forEach((a,n)=>{var u,s;const l=a.x*300+24,i=a.y*56+24;let r=l+200,c=i+56;const d=e[n+1];d&&(c=d.y*56+24),(u=a.children)!=null&&u.length&&xe(a.children,t),(a.x||a.y&&a.x)&&t.push({...a,isShadow:a.isShadow,isLeaf:!((s=a.children)!=null&&s.length),fromX:l,fromY:i,toX:r,toY:c})})},ot=$(()=>{let e=[];return Se(te.value,e),e}),Se=(e,t)=>{e.forEach(a=>{var n;t.push(a),(n=a.children)!=null&&n.length&&Se(a.children,t)})},Fe=$(()=>{let e=[];const[t={}]=te.value;return Me(t,e),e}),ke=(e=[],t,a=0,n=0)=>{e.map((l,i)=>{var c,d,u;const r=t[i-1];if((c=l.children)!=null&&c.length){const s=[],v=t[i-1];let w=n,k=0;if(v){const R=(u=v.children)!=null&&u.length?v.children[v.children.length-1]:{y:0,maxY:0};w=Math.max(R.y,v.y)+1,k=R.maxY}ke(l.children,s,a+1,w&&Math.max(w,k)),k=Math.max(s[s.length-1].maxY+1,k),t.push({...l,x:a,y:s[0].y,maxY:k,isShadow:!!l.isShadow,children:s}),I=Math.max(s[0].y,I),E=Math.max(a,E)}else{let s=i+n,v=0;if(r){const w=(d=r.children)!=null&&d.length?r.children[r.children.length-1]:{y:0,maxY:0};s=Math.max(w.y,r.y)+1,v+=s,s=Math.max(s,w.maxY)}t.push({...l,x:a,y:s,maxY:v,isShadow:!!l.isShadow}),I=Math.max(s,I),E=Math.max(a,E)}})},De=(e,{tableName:t,id:a},n,l)=>e.some((i,r)=>{var c;if(i.tableName===t&&a===i.id){const d=t+"_&&"+n;return i.isShadow&&o.visualNode.flag===d||(o.visualNode={tableName:"",isShadow:!0,flag:d},n==="b"?(o.visualNodeParent=l,e.splice(r+1,0,o.visualNode)):(o.visualNodeParent=i,i.children=[o.visualNode])),!0}return(c=i.children)!=null&&c.length?De(i.children,{tableName:t,id:a},n,i):!1}),Me=(e,t)=>{var l;let a=H.value.includes(e.id);(l=e.children)!=null&&l.length&&(a=e.children.some(i=>H.value.includes(i.id))||a);const n={...e,d:""};(e.children||[]).forEach(i=>{var c;let r=!0;A.value.some(d=>d.from===e.id&&i.id===d.to||d.from===i.id&&e.id===d.to?(r=!1,!0):!1),t.push({from:n,sqlChangeFlag:r&&a,isShadow:i.isShadow||e.isShadow,to:{...i},d:i.y===n.y?`M ${e.x*300+224} ${i.y*56+40} l 100 0`:`M ${e.x*300+240} ${n.y*56+40} l 0 ${(i.y-n.y)*56} l 84 0`}),(c=i.children)!=null&&c.length&&Me(i,t)})},st=e=>{e.preventDefault(),Ee()},lt=e=>{var c,d;e.preventDefault(),T.value=e.offsetX-de.offsetX,U.value=e.offsetY-de.offsetY;const t=o.nodeList.length,[a]=o.nodeList;if(!t)return;const[n]=a.children||[];if(!((c=a.children)!=null&&c.length)||n!=null&&n.isShadow){if(n!=null&&n.isShadow)return;o.visualNode={tableName:"",isShadow:!0,flag:"_&&"},o.nodeList[0].children=[o.visualNode],o.visualNodeParent=o.nodeList[0];return}let l=be.value.map(u=>{var Ie;const{fromX:s,fromY:v,toX:w,toY:k,isLeaf:R=!1,tableName:mt}=u;return[Le({left:T.value,right:T.value+200,top:U.value,bottom:U.value+32},{left:s,right:w,top:v,bottom:k}),R||((Ie=o.visualNode)==null?void 0:Ie.flag)===mt+"_&&r"?Le({left:T.value,right:T.value+200,top:U.value,bottom:U.value+32},{left:s+200,right:w+100,top:v,bottom:v+32}):0]}),i=0;l.reduce((u,s,v)=>{const w=Math.max(...u)>Math.max(...s);return i=w?i:v,w?u:s});let r=l[i];if(Array.isArray((d=o.visualNodeParent)==null?void 0:d.children)){const u=o.visualNodeParent.children.findIndex(s=>s.isShadow);u>-1&&o.visualNodeParent.children.splice(u,1)}if(o.visualNode=null,Math.max(...r)){const{tableName:u,isShadow:s=!1,id:v}=be.value[i],[w,k]=r;s||De(o.nodeList,{tableName:u,id:v},w>=k?"b":"r",o.nodeList[0])}},it=e=>{e.preventDefault()},dt=e=>{e.preventDefault();let t=e.dataTransfer.getData("text");const{tableName:a,type:n,datasourceId:l,name:i}=JSON.parse(t),r={info:JSON.stringify({table:a,sql:""}),noteName:i,unionType:"left",unionFields:[],currentDsFields:[],sqlVariableDetails:null};if(!o.nodeList.length){if(n==="sql"){o.visualNode={tableName:a,type:n,datasourceId:l,id:K(),...r},j.value={sql:"",tableName:a,id:o.visualNode.id,datasourceId:l},V.value=!0;return}o.nodeList.push({tableName:a,type:n,isShadow:!0,datasourceId:l,id:K(),...r}),h.value=o.nodeList[0],Q({datasourceId:l,id:h.value.id,info:h.value.info,tableName:a,type:n}).then(c=>{x.value=c,x.value.forEach(d=>{d.checked=!0}),o.nodeList[0].currentDsFields=P(c)}).finally(()=>{B.value=!0}),D(()=>{g("addComplete")});return}if(D(()=>{g("addComplete")}),!!o.visualNode){if(n==="sql"){j.value={sql:"",tableName:a,id:K(),datasourceId:l},V.value=!0;return}D(()=>{Object.assign(o.visualNode,{tableName:a,type:n,datasourceId:l,id:K(),...r}),g("joinEditor",[{tableName:a,type:n,datasourceId:l,id:o.visualNode.id,...r},o.visualNodeParent])})}},rt=(e,t)=>{delete t.children,delete e.children,oe([t,e],[t.id,e.id],o.nodeList),o.visualNode&&J()},Y=y(!1),qe=y(),ct={name:"",id:""},Ve=e=>{e.some(t=>{var a;if(t.id===S.id&&t.tableName!==S.name)return t.tableName=S.name,!0;(a=t.children)!=null&&a.length&&Ve(t.children)})},S=Be(P(ct)),ut=()=>{qe.value.validate(e=>{e&&(Ve(o.nodeList),S.name="",S.id="",Y.value=!1,g("reGetName"))})},ft=({name:e,id:t})=>{S.name=e,S.id=t,Y.value=!0},J=()=>{o.visualNode.isShadow=!1,delete o.visualNode.flag,o.visualNode=null,o.visualNodeParent=null},Ee=()=>{o.visualNodeParent&&(o.visualNodeParent.children=o.visualNodeParent.children.filter(e=>!e.isShadow),J())};q({nodeNameList:Ze,getNodeList:()=>P(p(o.nodeList)),setStateBack:rt,notConfirm:Ee,dfsNodeFieldBackReal:at,initState:Re,setChangeStatus:We,crossDatasources:Je});const ht=e=>{ee.value=e.id,_e(e,"editerField")},g=Ae;return(e,t)=>{const a=gt,n=Ct,l=_t,i=yt,r=Lt,c=Nt,d=wt,u=vt;return N(),b(z,null,[m("div",{onDrop:t[0]||(t[0]=s=>dt(s)),onDragenter:t[1]||(t[1]=s=>it(s)),onDragover:t[2]||(t[2]=s=>lt(s)),onDragleave:t[3]||(t[3]=s=>st(s)),class:"drag-mask_dataset",ref_key:"dragMask",ref:re,onClick:je,style:Pe({height:M.dragHeight+"px"})},[(N(),b("svg",{version:"1.1",baseProfile:"full",width:he.value,height:me.value,xmlns:"http://www.w3.org/2000/svg"},[(N(!0),b(z,null,se(Fe.value,s=>(N(),b("path",{key:s.d,class:"path-point",d:s.d,"stroke-dasharray":s.isShadow?"4,4":"0",stroke:s.isShadow?Te.value:"#BBBFC4","stroke-width":"1",fill:"none"},null,8,zt))),128)),(N(!0),b(z,null,se(ot.value,s=>(N(),b("foreignObject",{key:s.tableName,x:s.x*300+24,y:s.y*56+24,width:"200",height:"32"},[m("div",{onClick:v=>ht(s),class:He(["node-union",[{"shadow-node":s.isShadow,"active-node":ee.value===s.id}]]),ref_for:!0,ref:"activeNode"},[C(n,null,{default:_(()=>[C(a,null,{default:_(()=>[(N(),le(Oe(s.type!=="sql"?p(kt):p(Yt)),{class:"svg-icon"}))]),_:2},1024)]),_:2},1024),m("span",Kt,L(s.tableName),1),m("span",Qt,L(p(f)("data_set.custom_sql_here")),1),C(p(Pt),{style:{"margin-left":"auto"},iconName:p(Xt),menuList:s.type==="sql"?[...nt,...ye]:ye,onHandleCommand:v=>_e(s,v)},null,8,["iconName","menuList","onHandleCommand"])],10,Gt)],8,Wt))),128)),(N(!0),b(z,null,se(Fe.value,s=>(N(),b("foreignObject",{key:s.d,x:s.from.x*300+272,y:s.to.y*56+24,width:"32",height:"32"},[s.isShadow?W("",!0):(N(),b("div",{key:0,onClick:v=>tt(s),class:"path-union",style:Pe({borderColor:s.sqlChangeFlag?"#F54A45":""})},[C(n,null,{default:_(()=>[C(a,null,{default:_(()=>[(N(),le(Oe(Ue[s.to.unionType]),{class:"svg-icon"}))]),_:2},1024)]),_:2},1024)],12,ta))],8,ea))),128))],8,Rt)),M.maskShow?(N(),b("div",{key:0,class:He(["mask-dataset",[{"mask-dataset-none":!o.nodeList.length}]])},null,2)):W("",!0),o.nodeList.length?W("",!0):(N(),b("div",aa,[m("img",{src:p(Jt),alt:""},null,8,na),m("p",null,L(p(f)("data_set.on_the_left")),1),m("p",null,L(p(f)("data_set.a_data_set")),1)]))],36),C(d,{modelValue:Y.value,"onUpdate:modelValue":t[6]||(t[6]=s=>Y.value=s),"close-on-press-escape":!1,"close-on-click-modal":!1,title:p(f)("data_set.rename_table"),width:"420px"},{footer:_(()=>[m("span",oa,[C(c,{secondary:"",onClick:t[5]||(t[5]=s=>Y.value=!1)},{default:_(()=>[G(L(p(f)("common.cancel")),1)]),_:1}),C(c,{type:"primary",onClick:ut},{default:_(()=>[G(L(p(f)("common.sure")),1)]),_:1})])]),default:_(()=>[C(r,{ref_key:"renameForm",ref:qe,"require-asterisk-position":"right",model:S,"label-position":"top"},{default:_(()=>[C(i,{prop:"name",label:p(f)("data_set.table_name"),rules:[{required:!0,message:p(f)("commons.cannot_be_null")}]},{default:_(()=>[C(l,{placeholder:p(f)("common.inputText"),modelValue:S.name,"onUpdate:modelValue":t[4]||(t[4]=s=>S.name=s)},null,8,["placeholder","modelValue"])]),_:1},8,["label","rules"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),C(u,{"before-close":X,modelValue:B.value,"onUpdate:modelValue":t[7]||(t[7]=s=>B.value=s),"custom-class":"union-item-drawer",size:"600px",direction:"rtl"},Bt({footer:_(()=>[C(c,{secondary:"",onClick:X},{default:_(()=>[G(L(p(f)("dataset.cancel")),1)]),_:1}),C(c,{type:"primary",onClick:Ce},{default:_(()=>[G(L(p(f)("dataset.confirm")),1)]),_:1})]),default:_(()=>[x.value.length?(N(),le(Ot,{key:0,"field-list":x.value,node:h.value,onCheckedFields:Ke},null,8,["field-list","node"])):W("",!0)]),_:2},[h.value?{name:"header",fn:_(()=>[m("div",sa,[m("div",la,[m("span",ia,L(p(f)("data_set.table_name_de")),1),m("span",{title:h.value.tableName,class:"name ellipsis"},L(h.value.tableName),9,da)]),m("div",ra,[m("span",ca,L(p(f)("data_set.table_remarks")),1),m("span",{title:h.value.noteName,style:{"max-width":"240px"},class:"name ellipsis"},L(h.value.noteName||"-"),9,ua)]),m("span",{title:M.getDsName(h.value.datasourceId),style:{"max-width":"550px"},class:"ds ellipsis"},L(p(f)("auth.datasource"))+":"+L(M.getDsName(h.value.datasourceId)),9,fa)])]),key:"0"}:void 0]),1032,["modelValue"]),C(u,{direction:"btt","close-on-click-modal":!1,size:"calc(100% - 100px)","with-header":!1,"close-on-press-escape":!1,"modal-class":"sql-drawer-fullscreen",modelValue:V.value,"onUpdate:modelValue":t[8]||(t[8]=s=>V.value=s)},{default:_(()=>[C(Dt,{onSave:ze,onClose:Ge,sqlNode:j.value},null,8,["sqlNode"])]),_:1},8,["modelValue"])],64)}}});export{Va as _};
