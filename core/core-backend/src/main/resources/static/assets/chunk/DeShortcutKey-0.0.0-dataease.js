import{e as S}from"./eventBus-0.0.0-dataease.js";import{d as k}from"./dvMain-0.0.0-dataease.js";import{s as Z}from"./snapshot-0.0.0-dataease.js";import{a3 as O,ai as v}from"./vue-0.0.0-dataease.js";import{aa as G}from"./index-0.0.0-dataease.js";import{g as pe}from"./util-0.0.0-dataease.js";import{ai as fe,J as D}from"./index-0.0.0-dataease2.js";import{a as de}from"./canvasStyle-0.0.0-dataease.js";import{g as me,h as he,i as ye}from"./dataVisualization-0.0.0-dataease2.js";import{c as R,g as ve,a as Ce}from"./style-0.0.0-dataease.js";import{m as De,h as ge,j as Se}from"./canvasUtils-0.0.0-dataease.js";const we=O("contextmenu",{state:()=>({menuTop:0,menuLeft:0,menuShow:!1,position:"canvasCore"}),actions:{showContextMenu({top:e,left:t,position:o}){this.menuShow=!0,this.menuTop=e,this.menuLeft=t,this.position=o},hideContextMenu(){this.menuShow=!1}}}),Ie=()=>we(G);function M(e,t,o){e.style.left=e.style.left+o.left,e.style.top=e.style.top+o.top,e.groupStyle={},e.canvasId="canvas-main"}const ee=()=>pe(),w=k(),{curComponent:V,componentData:d,curOriginThemes:xe}=v(w),ke=O("compose",{state:()=>({areaData:{style:{top:0,left:0,width:0,height:0},components:[]},editorMap:{},isCtrlOrCmdDown:!1,isShiftDown:!1,laterIndex:null,editor:null}),actions:{getEditor(e="canvas-main"){this.editorMap[e]=fe("#editor-"+e)},setLaterIndex(e){this.laterIndex=e},setIsCtrlOrCmdDownStatus(e){this.isCtrlOrCmdDown=e},setIsShiftDownStatus(e){this.isShiftDown=e},setAreaData(e){this.areaData=e},updateGroupBorder(e){if(e){const t=e.replace("Group-",""),o=d.value.filter(n=>n.id===t)[0],a=o.propValue,s={...o.style};a.forEach(n=>{M(n,null,s)});const i={style:{top:0,left:0,width:0,height:0},components:a};this.calcComposeArea(i),o.style={...o.style,...i.style},a.forEach(n=>{n.canvasId=e}),R(o)}},alignment:function(e){const{areaData:t}=this;if(t.components.length===1){t.components=[];return}t.components.length>0&&t.style.width===0&&this.calcComposeArea();const{left:o,top:a,width:s,height:i}=t.style,n=o+s,u=o+s/2,c=a+i,f=a+i/2;t.components.forEach(l=>{e==="left"?l.style.left=o:e==="right"?l.style.left=n-l.style.width:e==="top"?l.style.top=a:e==="bottom"?l.style.top=c-l.style.height:e==="transverse"?l.style.left=u-l.style.width/2:e==="direction"&&(l.style.top=f-l.style.height/2)})},compose:function(e="canvas-main"){const t=this.editorMap[e],{areaData:o}=this;if(o.components.length===1){o.components=[];return}o.components.length>0&&this.calcComposeArea();const a=[];o.components.forEach(n=>{if(["Group"].includes(n.component)){const u={...n.style},c=n.propValue,f=t.getBoundingClientRect();c.forEach(l=>{M(l,f,u)}),a.push(...n.propValue)}else["DeTabs","GroupArea"].includes(n.component)||a.push(n)});const s=ee();a.forEach(n=>{n.canvasId="Group-"+s});const i=D({id:s,component:"Group",canvasActive:!1,name:"组合",label:"组合",icon:"group",expand:!0,commonBackground:{...me[xe.value],backgroundColorSelect:!1,innerPadding:0},...he,style:{...ye,...o.style},propValue:a});R(i),w.addComponent({component:i,index:void 0}),S.emit("hideArea-canvas-main"),this.batchDeleteComponent(o.components),w.setCurComponent({component:d.value[d.value.length-1],index:d.value.length-1}),this.areaData.components=[]},batchDeleteComponent(e){e.forEach(t=>{if(!["DeTabs","GroupArea"].includes(t.component)){for(let o=0,a=d.value.length;o<a;o++)if(t.id==d.value[o].id){d.value.splice(o,1);break}}})},decompose(e="canvas-main"){const t=this.editorMap[e],o={...V.value.style},a=V.value.propValue,s=t.getBoundingClientRect();w.deleteComponentById(V.value.id),a.forEach(i=>{M(i,s,o),w.addComponent({component:i,index:void 0,isFromGroup:!0})})},calcComposeArea(e=this.areaData){if(e.components<=1)return;let t=1/0,o=1/0,a=-1/0,s=-1/0;e.components.forEach(i=>{let n={left:0,top:0,right:0,bottom:0};n=ve(i.style),n.left<o&&(o=n.left),n.top<t&&(t=n.top),n.right>a&&(a=n.right),n.bottom>s&&(s=n.bottom)}),e.style={left:o,top:t,width:a-o,height:s-t}}}}),te=()=>ke(G),y=k(),m=te(),Ae=Ie(),{multiplexingStyleAdapt:Ee,curComponent:h,curComponentIndex:$,curMultiplexingComponents:Ke,dvInfo:W,pcMatrixCount:be,canvasStyleData:T,componentData:z}=v(y),{menuTop:Oe,menuLeft:Ge}=v(Ae),N=Z(),Me=O("copy",{state:()=>({copyDataArray:[],copyData:null,isCut:!1}),actions:{copyMultiplexingComponents(e,t=Ke.value,o=!1,a="multiplexing"){const s=this,{width:i,height:n,scale:u}=T.value;Object.keys(t).forEach(function(c,f){const l=D(t[c]);if(l.canvasId="canvas-main",o)l.style.top=l.style.height+l.style.top;else{const ue=f%2;a==="multiplexing"&&!Ee.value||(l.sizeX=be.value.x/2,l.sizeY=14,l.style.width=T.value.width/3*u/100,l.style.height=T.value.height/3*u/100),l.x=l.sizeX*ue+1,l.y=De()+10,l.style.left=0,l.style.top=0}s.copyData={data:[l],copyCanvasViewInfo:e,index:f,copyFrom:a},s.paste()})},copy(){h.value&&h.value.component!=="GroupArea"?this.copyDataInfo([h.value]):m.areaData.components.length&&this.copyDataInfo(m.areaData.components),this.isCut=!1},paste(e){if(!this.copyData)return;const t=this.copyData.data;let o=0;const a=this.copyData,s=t.length>1?300:10,i=setInterval(function(){if(o>=t.length)clearInterval(i);else{const n=t[o];W.value.type==="dataV"?e?(n.style.top=Oe,n.style.left=Ge):(n.style.top+=10,n.style.left+=10):n.y=n.y+n.sizeY;const u={},c=K(n,u);c.category="base",c.canvasId.includes("Group")&&(c.canvasId="canvas-main"),y.addCopyComponent(c,u,a.copyCanvasViewInfo),y.multiplexingStyleAdapt&&a.copyFrom==="multiplexing"&&de(c),W.value.type==="dashboard"&&S.emit("addDashboardItem-"+c.canvasId,c),o===t.length-1&&y.setCurComponent({component:c,index:z.value.length-1}),o++}},s);N.recordSnapshotCache()},cut(e=z.value){h.value&&h.value.component!=="GroupArea"?(this.copyDataInfo([h.value]),y.deleteComponentById(h.value.id,e)):m.areaData.components.length&&(this.copyDataInfo(m.areaData.components),m.areaData.components.forEach(t=>{y.deleteComponentById(t.id)}),m.setAreaData({style:{left:0,top:0,width:0,height:0},components:[]})),N.recordSnapshotCache(),this.isCut=!0},restorePreCutData(){if(this.isCut&&this.copyData){const e=D(this.copyData.data),t=this.copyData.index;y.addComponent({component:e,index:t}),$.value>=t&&$.value++}},copyDataArrayInfo(){this.copyDataArray=D(m.areaData.components)},copyDataInfo(e){this.copyData={data:D(e),index:$}}}});function It(e,t,o){const a=[];return t.forEach(s=>{const i=K(s,o);i.canvasId=e,a.push(i)}),a}function K(e,t){const o=D(e),a=ee();return t[e.id]=a,o.id=a,o.inMobile=!1,delete o.mStyle,delete o.mEvents,delete o.mPropValue,delete o.mCommonBackground,o.component==="Group"&&o.propValue.forEach((s,i)=>{o.propValue[i]=K(s,t)}),o.component==="DeTabs"&&o.propValue.forEach(s=>{s.componentData.forEach((i,n)=>{s.componentData[n]=K(i,t),s.componentData[n].canvasId=o.id+"--"+s.name})}),o}const Ve=()=>Me(G),$e=k(),{curComponent:q}=v($e),Te=O("lock",{actions:{lock(e=q.value){e.isLock=!0,e.component==="Group"&&e.propValue.forEach(t=>{t.isLock=!0})},unlock(e=q.value){e.isLock=!1,e.component==="Group"&&e.propValue.forEach(t=>{t.isLock=!1})}}}),Be=()=>Te(G),Le=k(),{curComponent:_,componentData:b}=v(Le),xt=e=>{const t=oe(e);return t?t.targetComponent:null},oe=e=>{if(e)return H(e);if(_.value)return H(_.value.id)},H=e=>{if(e){let t=0,o=0,a=b.value,s=null;return b.value.forEach((i,n)=>{e===i.id&&(t=n,s=i),i.component==="Group"&&i.propValue.forEach((u,c)=>{e===u.id&&(t=c,s=u,a=i.propValue)}),i.component==="DeTabs"&&i.propValue.forEach((u,c)=>{o=c,u.componentData.forEach((f,l)=>{e===f.id&&(t=l,s=f,a=u.componentData)})})}),{index:t,tabIndex:o,targetComponent:s,componentData:a}}},kt=(e,t="down")=>{e.sort((o,a)=>{const s=b.value.findIndex(n=>n.id===o.id),i=b.value.findIndex(n=>n.id===a.id);return t==="down"?i-s:s-i})},I=k(),p=te(),C=Z(),P=Ve(),ne=Be(),{curComponent:r,isInEditor:At,editMode:Pe}=v(I),{areaData:B}=v(p),Y=17,j=16,X=91,ae=37,se=38,ie=39,le=40,Re=86,We=67,ze=88,Ne=89,qe=90,_e=71,He=66,Ye=76,je=85,Xe=83,Fe=80,Je=68,re=46,Ue=8,Qe=69,Et=[8,37,38,39,40,66,67,68,69,71,76,80,83,85,86,88,89,90],ce={[Re]:tt,[Ne]:nt,[qe]:at,[Xe]:lt,[Fe]:rt,[Qe]:ct},F={[ae]:A,[se]:A,[ie]:A,[le]:A},J={...ce,[je]:pt},U={...ce,[We]:et,[ze]:ot,[_e]:st,[He]:it,[Je]:L,[re]:L,[Ye]:ut},Ze=()=>{let e=!1;return document.querySelectorAll(".ed-overlay").forEach(t=>{window.getComputedStyle(t).getPropertyValue("display")!="none"&&(e=!0)}),document.querySelectorAll(".ed-popper").forEach(t=>{window.getComputedStyle(t).getPropertyValue("display")!="none"&&(e=!0)}),document.querySelector(".tox-dialog-wrap")&&(e=!0),e};let g=!1,x=!1;function Kt(){window.onkeydown=e=>{if(Pe.value==="preview"||Ze())return;const{keyCode:t}=e;F[t]&&r.value?(F[t](t),e.preventDefault(),e.stopPropagation()):t===j?(x=!0,p.setIsShiftDownStatus(!0),Q("shift")):t===Y||t===X?(g=!0,p.setIsCtrlOrCmdDownStatus(!0),Q("ctrl")):(t==re||t==Ue)&&r.value?L():g&&(U[t]&&(!r.value||!r.value.isLock)?(e.preventDefault(),U[t]()):J[t]&&r.value&&r.value.isLock&&(e.preventDefault(),J[t]()))},window.onkeyup=e=>{e.keyCode===Y||e.keyCode===X?(g=!1,p.setIsCtrlOrCmdDownStatus(!1)):e.keyCode===j&&(x=!0,p.setIsShiftDownStatus(!1))},window.onmousedown=()=>{I.setInEditorStatus(!1)}}function bt(){g=!1,p.setIsCtrlOrCmdDownStatus(!1),x=!1,p.setIsShiftDownStatus(!1)}function Q(e){e==="shift"&&g?(g=!1,p.setIsCtrlOrCmdDownStatus(!1)):e==="ctrl"&&x&&(x=!1,p.setIsShiftDownStatus(!1))}function et(){P.copy()}function tt(){P.paste(!1),C.recordSnapshotCache("key-paste")}function A(e){if(r.value){const t=I.canvasStyleData.scale/100;e===ae?(r.value.style.left=r.value.style.left-t,E(-1,0)):e===ie?(r.value.style.left=r.value.style.left+t,E(1,0)):e===se?(r.value.style.top=r.value.style.top-t,E(0,-1)):e===le&&(r.value.style.top=r.value.style.top+t,E(0,1)),C.recordSnapshotCache("key-move")}}function E(e=0,t=0){const o=r.value.canvasId,a=document.querySelector("#editor-"+o);(ge(o)||Se(o))&&Ce(r.value,{width:a.offsetWidth,height:a.offsetHeight})}function ot(){P.cut()}function nt(){C.redo()}function at(){C.undo()}function st(){B.value.components.length&&(p.compose(),C.recordSnapshotCache("key-compose"))}function it(){const e=r.value;e&&!e.isLock&&e.component=="Group"&&(p.decompose(),C.recordSnapshotCache("key-decompose"))}function lt(){S.emit("save")}function rt(){S.emit("preview")}function L(){if(r.value&&r.value.component!=="GroupArea"){const e=oe();e&&I.deleteComponent(e.index,e.componentData)}else B.value.components.length&&(B.value.components.forEach(e=>{I.deleteComponentById(e.id)}),S.emit("hideArea-canvas-main"));C.recordSnapshotCache("listenGlobalKeyDown")}function ct(){S.emit("clearCanvas")}function ut(){ne.lock()}function pt(){ne.unlock()}export{Ie as a,Kt as b,te as c,Ve as d,oe as e,xt as f,ee as g,kt as h,It as i,Et as k,Be as l,bt as r};
