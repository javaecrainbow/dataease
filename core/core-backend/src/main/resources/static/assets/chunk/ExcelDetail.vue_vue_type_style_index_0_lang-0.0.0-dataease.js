import{u as ue}from"./index-0.0.0-dataease.js";import"./el-empty-0.0.0-dataease.js";import"./el-virtual-list-0.0.0-dataease.js";import{a as me,E as pe}from"./el-table-v2-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{j as fe,_ as C,w,x as ee,n as _e,y as he,e as ve}from"./index-0.0.0-dataease2.js";import{a as ge,E as xe}from"./el-form-item-0.0.0-dataease.js";import{E as ye}from"./el-upload-0.0.0-dataease.js";import"./el-progress-0.0.0-dataease.js";import{i as Ee}from"./icon_upload_outlined-0.0.0-dataease.js";import{e as Te,b as we,u as De}from"./datasource-0.0.0-dataease.js";import{g as ke}from"./base64-0.0.0-dataease.js";import Fe from"./ExcelInfo-0.0.0-dataease.js";import Ne from"./SheetTabs-0.0.0-dataease.js";import{i as je}from"./field-list-0.0.0-dataease.js";import{d as N,e as Be}from"./lodash-0.0.0-dataease.js";import{d as Oe,_ as A,t as ze,r as h,s as ae,m as Se,n as Le,o as Ie,a as Ve,ab as Ae,f as g,M as O,N as R,U as Re,g as z,i as m,j as s,k as r,a6 as te,a7 as j,a0 as S,V as qe,Z as Me,h as Ue,am as be}from"./vue-0.0.0-dataease.js";const Ke={class:"excel-detail"},Pe={class:"detail-inner"},$e={class:"upload-tip",style:{width:"100%"}},Ge={key:0,class:"ed-form-item__error"},Je={class:"title-form_primary"},Xe={key:0,class:"info-table"};function Ze(D){return typeof D=="function"||Object.prototype.toString.call(D)==="[object Object]"&&!be(D)}const pa=Oe({__name:"ExcelDetail",props:{param:{required:!1,default(){return A({id:"0",name:"",desc:"",type:"Excel",editType:0})},type:Object}},setup(D,{expose:le}){const u=D,{param:v}=ze(u),{t:l}=fe(),{emitter:L}=ue(),p=h(!1),q=ae([]),k={tableName:" ",sheetExcelId:"",fields:[],jsonArray:[],nameExist:!1,empty:"",overLength:!1},E=A(N(k)),f=A({excelData:[],defaultExpandedKeys:[],defaultCheckedKeys:[],fileList:null,sheets:[]}),F=Se(()=>{const[e={}]=f.excelData;return{name:e.excelLabel,size:e.excelLabel}}),M=h(!1),U={TEXT:"text",DATETIME:"time",LONG:"value",DOUBLE:"value"},se=e=>e.map(a=>({key:a.originName,fieldType:a.fieldType,dataKey:a.originName,title:a.name,width:150,headerCellRenderer:({column:o})=>{let t;return r("div",{class:"flex-align-center icon"},[r(ve,null,{default:()=>[r(C,null,Ze(t=Ue(je[U[o.fieldType]],{class:`svg-icon field-icon-${U[o.fieldType]}`}))?t:{default:()=>[t]})]}),r("span",{class:"ellipsis",title:o.title,style:{width:"100px"}},[o.title])])}})),oe=e=>{e.sheet&&(Object.assign(E,e),q.value=se(e.fields))},b=()=>{M.value=!0},K=e=>{var o;y.value=e.value;const a=(o=f.excelData[0])==null?void 0:o.sheets.find(t=>t.sheetId===e.value);oe(a)},P=e=>{f.excelData=[],y.value="",x.value=[],Object.assign(E,N(k)),e.toString().replace("Error: ","")},x=ae([]),y=h(""),ne=()=>{f.excelData=[],y.value="",x.value=[],Object.assign(E,N(k))},$=e=>{if((e==null?void 0:e.code)!==0){f.excelData=[],y.value="",x.value=[],Object.assign(E,N(k)),w.warning(e.msg);return}M.value=!1,v.value.name||(v.value.name=e.data.excelLabel),x.value=e.data.sheets.map(o=>{const{sheetId:t,tableName:n}=o;return{value:t,label:n}}),f.excelData=[e.data];const[a]=x.value;a&&K(a)},ie=(e,a,o)=>{var B;let t=[],n=[],_=!1,i=!1,d=(B=f.excelData[0])==null?void 0:B.sheets;for(let c=0;c<d.length;c++)d[c].sheet&&(d[c].effectExtField&&(_=!0),d[c].changeFiled&&(i=!0),t.push(d[c]),n.push(d[c].fieldsMd5));if(!t.length){w({message:l("dataset.ple_select_excel"),type:"error"});return}let T={};e&&(v.value.name=e.name),u.param.id?T={id:u.param.id,name:u.param.name,type:"Excel",sheets:t,editType:u.param.editType?u.param.editType:0}:T={id:u.param.id,name:u.param.name,type:"Excel",sheets:t,editType:0},u.param.editType===0&&u.param.id&&(_||i)?ee.confirm(l("deDataset.replace_the_data"),{confirmButtonText:l("dataset.confirm"),tip:l("data_source.to_replace_it"),cancelButtonText:"Cancel",confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1,callback:c=>{c==="confirm"&&G(n,T,e,a,o)}}):G(n,T,e,a,o)},G=(e,a,o,t,n)=>{for(let i=0;i<a.sheets.length;i++)a.sheets[i].data=[],a.sheets[i].jsonArray=[];a.configuration=ke.encode(JSON.stringify(a.sheets));let _=we;if(!a.id||a.id==="0"?(delete a.id,a.pid=o.pid):_=De,new Set(e).size!==e.length&&!u.param.id)ee.confirm(l("dataset.merge_title"),{confirmButtonText:l("dataset.merge"),tip:l("dataset.task.excel_replace_msg"),cancelButtonText:l("dataset.no_merge"),confirmButtonType:"primary",type:"warning",autofocus:!1,callback:i=>{i!=="close"&&(p.value=!0,a.mergeSheet=i==="confirm",i==="confirm"&&_(a).then(d=>{L.emit("showFinishPage",d),t==null||t(),w({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),p.value=!1}),i==="cancel"&&_(a).then(d=>{L.emit("showFinishPage",d),t==null||t(),w({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),p.value=!1}))}});else{if(p.value)return;p.value=!0,_(a).then(i=>{L.emit("showFinishPage",i),t==null||t(),w({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),p.value=!1})}},J=e=>{f.fileList=e},I=h(!0),X=Be(()=>{I.value=!1,Le(()=>{I.value=!0})},500);Ie(()=>{window.addEventListener("resize",X)}),Ve(()=>{window.removeEventListener("resize",X)});const Z=h(),H=h(),Q=()=>{const e=new FormData;return e.append("file",f.fileList.raw),e.append("type",""),e.append("editType",v.value.editType),e.append("id",v.value.id||0),p.value=!0,Te(e).then(a=>{var o,t;(o=Z.value)==null||o.clearFiles(),(t=H.value)==null||t.clearFiles(),$(a),p.value=!1}).catch(a=>{f.excelData=[],y.value="",x.value=[],Object.assign(E,N(k)),a.code==="ECONNABORTED"&&w({type:"error",message:a.message,showClose:!0}),p.value=!1})},W=h(),re=()=>W.value.validate,Y=h(!0),ce=e=>{Y.value=!1,$(e)},V=h(!1);return le({saveExcelDs:ie,submitForm:re,sheetFile:F,appendReplaceExcel:ce,uploadStatus:e=>{V.value=e}}),(e,a)=>{const o=_e,t=ye,n=ge,_=he,i=xe,d=me,T=pe,B=Ae("loading");return g(),O("div",Ke,[R("div",Pe,[Re((g(),z(i,{ref_key:"excelForm",ref:W,"require-asterisk-position":"right",model:s(v),"label-position":"top"},{default:m(()=>[F.value.name?(g(),z(n,{prop:"id",label:s(l)("data_source.document"),key:"sheetFile",rules:[{required:!0}]},{default:m(()=>[r(Fe,{onDel:ne,"show-del":"",name:F.value.name,size:F.value.size},null,8,["name","size"]),r(t,{action:"",multiple:!1,ref_key:"uploadAgain",ref:H,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":b,"on-change":J,"http-request":Q,"on-error":P,name:"file"},{trigger:m(()=>[r(o,{text:""},{default:m(()=>[te(j(s(l)("data_source.reupload")),1)]),_:1})]),_:1},512)]),_:1},8,["label"])):(g(),z(n,{prop:"id",key:"sheetId",label:s(l)("data_source.document"),rules:[{required:!0}]},{default:m(()=>[r(t,{multiple:!1,action:"",ref_key:"upload",ref:Z,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":b,"on-change":J,"http-request":Q,"on-error":P,name:"file"},{trigger:m(()=>[r(o,{secondary:""},{icon:m(()=>[r(s(C),{name:"icon_upload_outlined"},{default:m(()=>[r(s(Ee),{class:"svg-icon"})]),_:1})]),default:m(()=>[te(" "+j(s(l)("dataset.upload_file")),1)]),_:1})]),_:1},512),R("p",$e,j(s(l)("data_source.and_csv_formats")),1),V.value?(g(),O("div",Ge,j(s(l)("data_source.please_upload_files")),1)):S("",!0)]),_:1},8,["label"])),Y.value?(g(),z(n,{class:qe(V.value&&!F.value.name&&"error-status"),prop:"name",key:"name",rules:[{required:!0,message:s(l)("common.please_input")+s(l)("datasource.datasource")+s(l)("common.name")}],label:s(l)("visualization.custom")+s(l)("datasource.datasource")+s(l)("common.name")},{default:m(()=>[r(_,{modelValue:s(v).name,"onUpdate:modelValue":a[0]||(a[0]=c=>s(v).name=c),placeholder:s(l)("common.please_input")+s(l)("datasource.datasource")+s(l)("common.name")},null,8,["modelValue","placeholder"])]),_:1},8,["class","rules","label"])):S("",!0)]),_:1},8,["model"])),[[B,p.value]]),y.value?(g(),O(Me,{key:0},[R("div",Je,j(s(l)("chart.data_preview")),1),r(Ne,{activeTab:y.value,onTabClick:K,"tab-list":x.value},null,8,["activeTab","tab-list"]),I.value?(g(),O("div",Xe,[r(T,null,{default:m(({height:c,width:de})=>[r(d,{columns:q.value,"header-class":"excel-header-cell",data:E.jsonArray,width:de,height:c,fixed:""},null,8,["columns","data","width","height"])]),_:1})])):S("",!0)],64)):S("",!0)])])}}});export{pa as _};
