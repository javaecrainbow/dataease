import{l as H,C as X,a as U,M as q,k as F,A as j,m as K}from"./dataVisualization-0.0.0-dataease2.js";import{e as J}from"./eventBus-0.0.0-dataease.js";import{d as Q}from"./dvMain-0.0.0-dataease.js";import{g as L,h as R,i as Z,u as B,j as $,k as I,l as aa}from"./dataVisualization-0.0.0-dataease.js";import{ai as ea}from"./vue-0.0.0-dataease.js";import{d as v,J as E,w as ta}from"./index-0.0.0-dataease2.js";import{v as ia,S as z}from"./chart-0.0.0-dataease.js";import{s as ra}from"./snapshot-0.0.0-dataease.js";import"./index-0.0.0-dataease.js";import{d as w}from"./lodash-0.0.0-dataease.js";const Aa=a=>v.post({url:"/linkage/getViewLinkageGatherArray",data:a}),wa=a=>v.post({url:"/linkage/saveLinkage",data:a}),x=a=>v.get({url:"/linkage/getVisualizationAllLinkageInfo/"+a}),Ta=a=>v.post({url:"/linkage/updateLinkageActive",data:a}),Va=a=>v.post({url:"/linkage/removeLinkage",data:a});function ba(a,e){return v.get({url:"/linkJump/queryWithViewId/"+a+"/"+e})}function Na(a){return v.post({url:"/linkJump/updateJumpSet",data:a,loading:!0})}function Ca(a){return v.post({url:"/linkJump/queryTargetVisualizationJumpInfo",data:a,loading:!0})}function P(a){return v.get({url:"/linkJump/queryVisualizationJumpInfo/"+a,loading:!1})}function za(a){return v.get({url:"/linkJump/viewTableDetailList/"+a,loading:!1})}function Ma(a){return v.post({url:"/linkJump/updateJumpSetActive",data:a,loading:!0})}function Ba(a){return v.post({url:"/linkJump/removeJumpSet",data:a,loading:!0})}const f=Q(),{inMobile:sa,curBatchOptComponents:Oa,dvInfo:D,canvasStyleData:W,componentData:h,canvasViewInfo:T,appData:O}=ea(f),oa=ra();function Ja(a){const e=a.split("&"),t=e[0],i=e[1];return na(t,i)}function na(a,e,t){let i;if(H.forEach(r=>{(r.component===a||r.component===e)&&(i=w(r),i.innerType=e,i.innerType==="richText"&&(i.propValue={textValue:""}),f.curOriginThemes==="light"?i.commonBackground=w(X):i.commonBackground=w(U))}),a==="UserView"){const r=ia(e);i.name=r==null?void 0:r.title,i.label=r==null?void 0:r.title,i.render=r==null?void 0:r.render,i.isPlugin=!!t,i.isPlugin&&(i.staticMap=t)}return i}function La(a,e){const t=a.target.dataset.id;e==="dashboard"?J.emit("handleDragStartMoveIn-canvas-main",t):a.dataTransfer.setData("id",t)}function xa(a,e){e==="dashboard"&&J.emit("handleDragEnd-canvas-main",a)}function V(a){a.x=1+(a.x-1)*2,a.y=1+(a.y-1)*2,a.sizeX=a.sizeX*2,a.sizeY=a.sizeY*2,a.mx=1+(a.mx-1)*2,a.my=1+(a.my-1)*2,a.mSizeX=a.mSizeX*2,a.mSizeY=a.mSizeY*2,a.component==="Group"?a.propValue.forEach(e=>{V(e)}):a.component==="DeTabs"&&a.propValue.forEach(e=>{e.componentData.forEach(t=>{V(t)})})}function C(a,e,t,i,r){a.canvasActive=!1,a.component==="VQuery"&&(t==null?void 0:t.source)==="report"&&e&&a.propValue.forEach((o,l)=>{e[o.id]&&(a.propValue[l]=JSON.parse(e[o.id].filterInfo))}),a.component==="Group"&&(a.expand=a.expand||!1),a.component==="Picture"&&(a.style.adaptation=a.style.adaptation||"adaptation"),a.style.adaptation=a.style.adaptation||"adaptation",a.style.borderActive===void 0?(a.style.borderActive=!1,a.style.borderWidth=1,a.style.borderRadius=5,a.style.borderStyle="solid",a.style.borderColor="#cccccc"):(a.style.borderWidth=a.style.borderWidth===void 0?1:a.style.borderWidth,a.style.borderRadius=a.style.borderRadius===void 0?5:a.style.borderRadius,a.style.borderStyle=a.style.borderStyle===void 0?"solid":a.style.borderStyle,a.style.borderColor=a.style.borderColor===void 0?"#cccccc":a.style.borderColor),a.maintainRadio=a.maintainRadio||!1,a.multiDimensional=a.multiDimensional||E(q),a.carousel=a.carousel||E(F),a.aspectRatio=a.aspectRatio||1,a.component==="UserView"&&(a.actionSelection=a.actionSelection||E(j)),(!i||i===2)&&(r==null?void 0:r.type)==="dashboard"&&V(a),a.events=a.events&&a.events.checked!==void 0&&a.events.type!=="displayChange"?a.events:E(K),a.events.jump.type=a.events.jump.type||"_blank",a.category=a.category||"base",a.component==="DeTabs"?a.propValue.forEach(o=>{o.componentData.forEach(l=>{C(l,e,t,i,r)})}):a.component==="Group"&&a.propValue.forEach(o=>{C(o,e,t,i,r)})}function G(a,e,t,i,r){a.component.seniorStyleSetting=a.component.seniorStyleSetting||E(z),a.suspensionButtonAvailable=a.suspensionButtonAvailable===void 0?!1:a.suspensionButtonAvailable,a.screenAdaptor=a.screenAdaptor||"widthFirst",a.refreshBrowserEnable=a.refreshBrowserEnable===void 0?!1:a.refreshBrowserEnable,a.refreshBrowserUnit=a.refreshBrowserUnit||"minute",a.refreshBrowserTime=a.refreshBrowserTime||5,a.scaleWidth=a.scale,a.scaleHeight=a.scale,a.popupAvailable=a.popupAvailable===void 0?!0:a.popupAvailable,a.popupButtonAvailable=a.popupButtonAvailable===void 0?!0:a.popupButtonAvailable;const o=t==null?void 0:t.reportFilterInfo;e.forEach(l=>{C(l,o,i,r,t)})}function Pa(a,e){const t=h.value.filter(i=>["ScrollText"].includes(i.component)||i.innerType==="rich-text");if(t&&t.length>0){const i=t.map(r=>r.id);L(a,e,{}).then(r=>{const o=r.data,n=JSON.parse(o.componentData).reduce((s,d)=>(s[d.id]=d,s),{});for(let s=0;s<h.value.length;s++){const d=h.value[s];if(i.includes(d.id)&&n[d.id])if(sa.value)h.value[s].propValue=n[d.id].propValue;else{const{top:u,left:y,height:m,width:g,fontSize:S}=h.value[s].style;n[d.id].style.top=u,n[d.id].style.left=y,n[d.id].style.height=m,n[d.id].style.width=g,S&&(n[d.id].style.fontSize=S),h.value[s]=n[d.id]}}})}}function M(a,e,t){const i=e!=null&&e.includes("-copy"),r=i?e.split("-")[0]:e,o=i?aa:L;let l={source:"main"};if(f.canvasAttachInfo&&f.canvasAttachInfo.taskId&&(l={source:"report",taskId:f.canvasAttachInfo.taskId},f.canvasAttachInfo.hasOwnProperty("showWatermark")&&typeof f.canvasAttachInfo.showWatermark<"u"&&f.canvasAttachInfo.showWatermark!==null)){const s=f.canvasAttachInfo.showWatermark==="true";l.showWatermark=s}o(a,r,l).then(n=>{const s=n.data,d={...s.watermarkInfo,settingContent:JSON.parse(s.watermarkInfo.settingContent)},u={id:s.id,name:s.name,pid:s.pid,status:s.status,selfWatermarkStatus:s.selfWatermarkStatus,type:s.type,creatorName:s.creatorName,updateName:s.updateName,createTime:s.createTime,updateTime:s.updateTime,watermarkInfo:d,weight:s.weight,mobileLayout:s.mobileLayout||!1},y=s.version,m=JSON.parse(s.componentData),g=JSON.parse(s.canvasStyleData),S=s.canvasViewInfo;G(g,m,s,l,y),g.component.seniorStyleSetting=g.component.seniorStyleSetting||E(z);const k=u.type==="dashboard"&&g.dashboard.gap==="yes"?g.dashboard.gapSize:0;t({canvasDataResult:m,canvasStyleResult:g,dvInfo:u,canvasViewInfoPreview:S,curPreviewGap:k})})}async function Wa(a,e,t){M(a,e,function({canvasDataResult:i,canvasStyleResult:r,dvInfo:o,canvasViewInfoPreview:l}){f.setComponentData(i),f.setCanvasStyle(r),f.updateCurDvInfo(o),f.setCanvasViewInfo(l),x(o.id).then(n=>{f.setNowPanelTrackInfo(n.data)}),P(o.id).then(n=>{f.setNowPanelJumpInfo(n.data)}),t({canvasDataResult:i,canvasStyleResult:r,dvInfo:o,canvasViewInfoPreview:l})})}async function Ga(a,e,t,i){M(a,t,function({canvasDataResult:r,canvasStyleResult:o,canvasViewInfoPreview:l}){const n=r.filter(u=>!!u.inMobile),s=n.map(u=>u.id);h.value.forEach(u=>{if(u.inMobile=s.includes(u.id),u.inMobile){const{mx:y,my:m,mSizeX:g,mSizeY:S,mPropValue:k,mEvents:b,mCommonBackground:N}=n.find(A=>A.id===u.id);u.mx=y,u.my=m,u.mSizeX=g,u.mSizeY=S,u.mEvents=b,u.mCommonBackground=N,u.component==="VQuery"&&(u.mPropValue=k),u.component==="DeTabs"&&u.propValue.forEach(A=>{A.componentData.forEach(p=>{p.mx=p.mx,p.my=p.my,p.mSizeX=p.mSizeX,p.mSizeY=p.mSizeY,p.mEvents=tEvents,p.mCommonBackground=tCommonBackground,p.component==="VQuery"&&(p.mPropValue=tPropValue)})})}}),Object.keys(e).forEach(u=>{if(T.value[u]&&e[u]){const{customAttrMobile:y,customStyleMobile:m}=e[u];T.value[u].customStyleMobile=m,T.value[u].customAttrMobile=y}}),f.setComponentData(h.value);const d=w(W.value);d.mobileSetting?d.mobileSetting=o.mobileSetting:d.mobileSetting={backgroundColorSelect:!1,background:"",color:"#ffffff",backgroundImageEnable:!1,customSetting:!1},f.setCanvasStyle(d),i()})}function _a(a,e,t){M(a,e,function({canvasDataResult:i,canvasStyleResult:r,dvInfo:o,canvasViewInfoPreview:l}){const n=i.filter(s=>!!s.inMobile);i.forEach(s=>{const{mx:d,my:u,mSizeX:y,mSizeY:m,mStyle:g,mPropValue:S,mEvents:k,mCommonBackground:b,style:N,propValue:A,events:p,commonBackground:_}=s;s.x=d,s.y=u,s.sizeX=y,s.sizeY=m,s.style=g||N,s.propValue=S||A,s.events=k||p,s.commonBackground=b||_,s.component==="DeTabs"&&s.propValue.forEach(Y=>{Y.componentData.forEach(c=>{c.x=c.mx,c.y=c.my,c.sizeX=c.mSizeX,c.sizeY=c.mSizeY,c.style=c.mStyle||c.style,c.propValue=c.mPropValue||c.propValue,c.events=c.mEvents||c.events,c.commonBackground=c.mCommonBackground||c.commonBackground})})}),l&&Object.keys(l).forEach(s=>{const d=l[s],{customAttrMobile:u,customStyleMobile:y}=d;d.customAttr=u||d.customAttr,d.customStyle=y||d.customStyle}),f.setComponentData(n),f.setCanvasStyle(r),f.updateCurDvInfo(o),f.setCanvasViewInfo(l),x(o.id).then(s=>{f.setNowPanelTrackInfo(s.data)}),P(o.id).then(s=>{f.setNowPanelJumpInfo(s.data)}),t({canvasDataResult:n,canvasStyleResult:r,dvInfo:o,canvasViewInfoPreview:l})})}async function Ya(a){f.removeGroupArea();const e=w(h.value);e.forEach(o=>{o.component==="UserView"?o.linkageFilters=[]:o.component==="Group"?o.propValue.forEach(l=>{l.linkageFilters=[]}):o.component==="DeTabs"&&o.propValue.forEach(l=>{l.componentData.forEach(n=>{n.linkageFilters=[]})})});const t={canvasStyleData:JSON.stringify(W.value),componentData:JSON.stringify(e),canvasViewInfo:T.value,appData:O.value,...D.value,watermarkInfo:null};let i="success";if(O.value&&await Z({datasetFolderPid:t.datasetFolderPid,datasetFolderName:t.datasetFolderName}).then(o=>{i=o.data}),i==="repeat"){ta.error("数据集分组名称已存在");return}const r=D.value.id&&D.value.optType!=="copy"?B:$;r===B&&await I({opt:"edit",nodeType:"leaf",name:D.value.name,type:D.value.type,id:D.value.id}),r(t).then(o=>{f.updateDvInfoId(o.data),oa.resetStyleChangeTimes(),a(o)})}function Ha(a){return a&&(/^(http(s)?:\/\/)/.test(a.toLowerCase())?a:"http://"+a)}function Xa(a,e,t,i){if(!t)return t;let r=t;const o=i.reduce((n,s)=>(n[s[a]]=s[e],n),{}),l=t.match(/\[(.+?)\]/g);return l&&l.forEach(n=>{const s=n.slice(1,-1);r=r.replace(n,o[s])}),r}function la(a){return a==="canvas-main"}function Ua(a,e){return a.canvasId===e}function qa(a){return ua(a)||da(a)}function ua(a){return a&&a.includes("Group")}function da(a){return a&&!a.includes("Group")&&!la(a)}function Fa(a,e=h.value){let t=-1;return e.forEach((i,r)=>{i.id===a&&(t=r)}),t}function ja(a,e,t=!1){const i=document.querySelector(t?"#point-shadow-main":"#shape-id-"+a.id),r=i.offsetWidth,o=i.offsetHeight;if(a.sizeX=Math.round(r/e.baseWidth),a.sizeY=Math.round(o/e.baseHeight),a.style.width=r,a.style.height=o,t){const l=i.offsetLeft,n=i.offsetTop;a.x=Math.round(l/e.baseWidth),a.y=Math.round(n/e.baseHeight),a.style.left=l,a.style.height=n}}function Ka(a,e){a.forEach(t=>{t.component==="UserView"&&t.innerType!="VQuery"?e.push(t.id):t.component==="Group"?t.propValue.forEach(i=>{e.push(i.id)}):t.component==="DeTabs"&&t.propValue.forEach(i=>{i.componentData.forEach(r=>{e.push(r.id)})})})}function fa(a){return a.filter(e=>e.leaf?!0:e.children&&e.children.length>0?(e.children=fa(e.children),!0):!1)}function Qa(a,e){function t(i,r){if(i.children)for(const o of i.children){if(o.id===r)return i.id;const l=t(o,r);if(l!==null)return l}return null}for(const i of a){const r=t(i,e);if(r!==null)return r}return null}async function Ra(a,e){let t;await R(a).then(i=>{const r=i.data,o=JSON.parse(r.componentData),l=r.appData,n=JSON.parse(r.canvasStyleData);o.forEach(s=>{(!r.version||r.version===2)&&r.type==="dashboard"&&V(s)}),n.component.seniorStyleSetting=n.component.seniorStyleSetting||E(z),n.scaleWidth=n.scale,n.scaleHeight=n.scaleHeight,t={canvasStyleData:n,componentData:o,canvasViewInfo:r.canvasViewInfo,appData:l,baseInfo:{preName:r.name}}}).catch(i=>{console.error(i)}),G(t.canvasStyleData,t.componentData,null,null,null),e(t)}function Za(){return D.value.type==="dashboard"}function $a(a,e,t,i){const{width:r,height:o}=a.style,l=r,n=o;function s(u){return u===2?75:75+Math.floor(u-2)*35}e.left<0?e.left=0:l-e.left<60&&(e.left=e.left-60);const d=s(i);e.top<0?e.top=0:e.top+d+60>n&&(e.top=e.top-d)}function ca(a){a&&Array.isArray(a)&&(a.sort((e,t)=>e.y-t.y),a.forEach(e=>{e.component==="DeTabs"&&e.propValue.forEach(t=>{ca(t.componentData)})}))}function Ia(){return h.value.length===0?1:h.value.filter(a=>a.y).map(a=>a.y+a.sizeY).reduce((a,e)=>Math.max(a,e),0)}function ae(a){let e;return h.value.forEach(t=>{t.id===a?e=t:t.component==="Group"?t.propValue.forEach(i=>{i.id===a&&(e=i)}):t.component==="DeTabs"&&t.propValue.forEach(i=>{i.componentData.forEach(r=>{r.id===a&&(e=r)})})}),e}function ee(a){try{console.info("Canvas initReady");const e={type:"dataease-embedded-interactive",eventName:"canvas_init_ready",args:a};window.parent.postMessage(e,"*")}catch{console.warn("de_inner_params send error")}}function te(a){if(a){const e=T.value[a.id];e.customStyle=a.customStyle,e.customAttr=a.customAttr,e.title=a.title,e.name=a.name}}export{fa as A,ba as B,Na as C,za as D,Ka as E,Aa as F,Xa as G,Ha as H,M as I,$a as J,Qa as K,ae as L,Ga as M,Ca as N,_a as O,te as P,xa as a,Ya as b,La as c,Ra as d,Ja as e,na as f,x as g,ua as h,Wa as i,da as j,la as k,Za as l,Ia as m,qa as n,ee as o,Ua as p,P as q,ca as r,wa as s,Fa as t,ja as u,Pa as v,Ma as w,Ta as x,Va as y,Ba as z};
