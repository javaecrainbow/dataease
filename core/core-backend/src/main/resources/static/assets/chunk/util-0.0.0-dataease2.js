import"./chart-0.0.0-dataease.js";import{a3 as defineStore,m as computed,an as toRaw}from"./vue-0.0.0-dataease.js";import{aa as store}from"./index-0.0.0-dataease.js";import{d as request,j as useI18n,L as useLinkStoreWithOut,w as ElMessage}from"./index-0.0.0-dataease2.js";import{i as innerExportDetails}from"./chart-0.0.0-dataease2.js";import{useAppStoreWithOut}from"./app-0.0.0-dataease.js";import{D as isNumber}from"./lodash-0.0.0-dataease.js";const useMapStore=defineStore("map",{state:()=>({mapCache:{},mapKey:{key:"",securityCode:""}}),actions:{setMap({id:e,geoJson:s}){this.mapCache[e]=s},setKey(e){this.mapKey=e}}}),useMapStoreWithOut=()=>useMapStore(store),getWorldTree=()=>request.get({url:"/map/worldTree"}),getGeoJson=e=>{let s="/map",o=e;isCustomGeo(e)&&(s="/geo",o=getBusiGeoCode(e));const n=o.substring(0,3),i=`${s}/${n}/${o}.json`;return request.get({url:i})},isCustomGeo=e=>e.startsWith("geo_"),getBusiGeoCode=e=>e.substring(4),appStore=useAppStoreWithOut(),isDataEaseBi=computed(()=>appStore.getIsDataEaseBi),{t}=useI18n();function hexColorToRGBA(hex,alpha){let rgb=[];if(hex.indexOf("#")>-1){if(/^\#[0-9A-F]{3}$/i.test(hex)){let e="#";hex.replace(/[0-9A-F]/gi,function(s){e+=s+s}),hex=e}return/^#[0-9A-F]{6}$/i.test(hex)?(hex.replace(/[0-9A-F]{2}/gi,function(kw){rgb.push(eval("0x"+kw))}),`rgba(${rgb.join(",")},${alpha/100})`):"rgb(0,0,0)"}else return rgb=hex.match(/\d+/g),`rgba(${rgb.join(",")},${alpha/100})`}const quotaViews=["label","richTextView","indicator","gauge","liquid"];function handleEmptyDataStrategy(e,s){const{data:o}=s,n=e.type.includes("chart-mix");if(!(o!=null&&o.length))return s;const i=parseJson(e.senior).functionCfg.emptyDataStrategy;if(i==="ignoreData"){if(n)for(let c=0;c<o.length;c++)handleIgnoreData(o[c]);else handleIgnoreData(o);return s}const{yAxis:l,xAxisExt:r,extStack:a}=e,p=(l==null?void 0:l.length)>=2||(r==null?void 0:r.length)>0||(a==null?void 0:a.length)>0;switch(i){case"breakLine":{if(p)if(n)for(let c=0;c<o.length;c++)handleBreakLineMultiDimension(o[c]);else handleBreakLineMultiDimension(o);return{...s,connectNulls:!1}}case"setZero":{if(p)if(n)for(let c=0;c<o.length;c++)handleSetZeroMultiDimension(o[c]);else handleSetZeroMultiDimension(o);else if(n)for(let c=0;c<o.length;c++)handleSetZeroSingleDimension(o[c]);else handleSetZeroSingleDimension(o);break}}return s}function handleBreakLineMultiDimension(e){const s=new Map,o=new Set,n=new Map;for(let l=0;l<e.length;l++){const r=e[l],a=s.get(r.field);a?a.set.add(r.category):s.set(r.field,{set:new Set([r.category]),index:l}),o.add(r.category),n.set(r.category,r.quotaList)}let i=0;s.forEach((l,r)=>{if(l.set.size<o.size){let a=0;o.forEach(p=>{l.set.has(p)||e.splice(l.index+i+a,0,{field:r,value:null,category:p,quotaList:n.get(p)}),a++}),i+=o.size-l.set.size}})}function handleSetZeroMultiDimension(e){const s=new Map,o=new Set,n=new Map;for(let l=0;l<e.length;l++){const r=e[l];r.value===null&&(r.value=0);const a=s.get(r.field);a?a.set.add(r.category):s.set(r.field,{set:new Set([r.category]),index:l}),o.add(r.category),n.set(r.category,r.quotaList)}let i=0;s.forEach((l,r)=>{if(l.set.size<o.size){let a=0;o.forEach(p=>{l.set.has(p)||e.splice(l.index+i+a,0,{field:r,value:0,category:p,quotaList:n.get(p)}),a++}),i+=o.size-l.set.size}})}function handleSetZeroSingleDimension(e){e.forEach(s=>{s.value===null&&(s.value=0)})}function handleIgnoreData(e){for(let s=e.length-1;s>=0;s--)e[s].value===null&&e.splice(s,1)}function resetRgbOpacity(e,s){if(e!=null&&e.startsWith("rgb")){const o=e.match(/(\d(\.\d+)?)+/g);if((o==null?void 0:o.length)===4){const n=parseFloat(o[3]);if(isNumber(n)){let i=parseFloat((n*s).toFixed(2));return i>1&&(i=1),`rgba(${o.slice(0,3).concat(i.toString()).join(",")})`}}}return e}function parseJson(e){return typeof e!="string"?e:JSON.parse(e)}function flow(...e){return(s,o,n,i)=>e.reduce((l,r)=>i?r.call(i,s,l,n):r(s,l,n),o)}const isParent=(e,s)=>{let o=e;for(;o;){if(o===s)return!0;o=o.__proto__}return!1},getGeoJsonFile=async e=>{const s=useMapStoreWithOut();let o=s.mapCache[e];return o||(o=(await getGeoJson(e)).data,s.setMap({id:e,geoJson:o})),toRaw(o)},getExcelDownloadRequest=e=>{var p;const s=JSON.parse(JSON.stringify(e.fields)),o=JSON.parse(JSON.stringify(e.tableRow)),n=s.map(c=>c.chartShowName??c.name),i=s.map(c=>c.deType),l=s.map(c=>c.dataeaseName);let r=o.map(c=>l.map(f=>c[f])),a=[];return(p=e.detailFields)!=null&&p.length&&(a=e.detailFields.map(c=>({name:c.name,deType:c.deType,dataeaseName:c.dataeaseName})),r=o.map(c=>l.map(f=>{if(f==="detail"&&!c[f]&&Array.isArray(c.details)){const u=c.details;return u!=null&&u.length?u.map(h=>a.map(g=>h[g.dataeaseName])):null}return c[f]}))),{header:n,details:r,excelTypes:i,excelHeaderKeys:l,detailFields:a}},exportExcelDownload=(e,s)=>{const o=e.title;let n={proxy:null,viewId:e.id,viewInfo:e,viewName:o,downloadType:e.downloadType};if(e.type.includes("chart-mix")){const l=getExcelDownloadRequest(e.data.left),r=getExcelDownloadRequest(e.data.right);n={...n,multiInfo:[l,r]},e.downloadType==="dataset"&&delete n.multiInfo}else{const l=getExcelDownloadRequest(e.data);n={...n,...l}}e.type.includes("symbolic-map")&&(n.detailFields=[]);const i=useLinkStoreWithOut();(isDataEaseBi.value||appStore.getIsIframe)&&(n.dataEaseBi=!0),innerExportDetails(n).then(l=>{if(i.getLinkToken||isDataEaseBi.value||appStore.getIsIframe){const r=new Blob([l.data],{type:"application/vnd.ms-excel"}),a=document.createElement("a");a.style.display="none",a.href=URL.createObjectURL(r),a.download=o+".xlsx",document.body.appendChild(a),a.click(),document.body.removeChild(a)}else s&&s(l)}).catch(()=>{console.error("Excel download error"),s("error")})},copyString=(e,s=!1)=>{(navigator.clipboard||{writeText:n=>new Promise(i=>{const l=document.createElement("textarea");l.setAttribute("style","z-index: -1;position: fixed;opacity: 0;"),l.value=n,document.body.appendChild(l),l.select(),document.execCommand("copy"),l.remove(),i()})}).writeText(e).then(()=>{s&&ElMessage.success(t("commons.copy_success"))})},getDynamicColorScale=(e,s,o,n)=>{const i=(s-e)/o,l=[];for(let r=0;r<o;r++)l.push({value:[e+r*i,e+(r+1)*i],color:n==null?void 0:n[r],label:`${(e+r*i).toFixed(0)} - ${(e+(r+1)*i).toFixed(0)}`});return l},filterChartDataByRange=(e,s,o)=>e.filter(n=>n.value===null||n.value===void 0||n.value>=o&&n.value<=s),getMaxAndMinValueByData=(e,s,o,n,i)=>{const l=r=>e.reduce((a,p)=>r?p[s]>a?p[s]:a:p[s]<a?p[s]:a,r?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);if(n===null||o===null){let r=o,a=n;r===null&&(r=l(!0)),a===null&&(a=l(!1)),i(r,a)}if(n===0&&o===0){const r=l(!0),a=l(!1);i(r,a)}},stepsColor=(e,s,o,n)=>{let i,l,r,a;const p=[],c=[];n=n||1;const f=function(g){return Math.pow(g/255,n)};for(e=u(e).map(f),s=u(s).map(f),i=0;i<o;i++){for(r=o-1===0?0:i/(o-1),a=1-r,l=0;l<3;l++)c[l]=h(Math.round(Math.pow(e[l]*a+s[l]*r,1/n)*255).toString(16));p.push("#"+c.join(""))}function u(g){return g.length===4?g.substr(1).split("").map(function(d){return 17*parseInt(d,16)}):[g.substr(1,2),g.substr(3,2),g.substr(5,2)].map(function(d){return parseInt(d,16)})}function h(g){return g.length===1?"0"+g:g}return p},getMapColorCases=e=>JSON.parse(JSON.stringify(e)).map(o=>{let n=o.colors;["fresh","red","spiritual"].includes(o.value)&&(n=o.colors.reverse());const i=n.length,l=n[0],r=n[i-1];return{name:o.name,value:o.value+"_split_gradient",baseColors:[l,r],colors:stepsColor(l,r,9,1)}});function getColor(e){const s=parseJson(e.customAttr).basicStyle,{seriesColor:o}=s;if(o!=null&&o.length){const{yAxis:n}=e,i=o.reduce((r,a)=>(r[a.id]=a,r),{});return n==null||n.forEach((r,a)=>{const p=i[r.id];p&&(a+1>s.colors.length?s.colors.push(p.color):s.colors[a]=p.color)}),s.colors.map(r=>hexColorToRGBA(r,s.alpha))}}function setupSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,l=e.yAxis;return l==null||l.forEach(r=>{n.has(r.id)||(n.add(r.id),o.push({id:r.id,name:r.chartShowName??r.name,color:i[(n.size-1)%i.length]}))}),o}function getGroupColor(e,s){const{basicStyle:o}=parseJson(e.customAttr),{seriesColor:n}=o;if(!(n!=null&&n.length))return;const i=n.reduce((c,f)=>(c[f.id]=f,c),{}),{yAxis:l,xAxisExt:r}=e,{data:a}=s;if(r!=null&&r.length){const c=new Set;a==null||a.forEach(u=>u.category!==null&&c.add(u.category)),[...c].forEach((u,h)=>{const g=i[u];g&&(h+1>o.colors.length?o.colors.push(g.color):o.colors[h]=g.color)})}else l==null||l.forEach((c,f)=>{const u=i[c.id];u&&(f+1>o.colors.length?o.colors.push(u.color):o.colors[f]=u.color)});return o.colors.map(c=>hexColorToRGBA(c,o.alpha))}function setUpGroupSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,{yAxis:l,xAxisExt:r}=e;return r!=null&&r.length?s==null||s.forEach(a=>{a.value===null||a.category===null||n.has(a.category)||(n.add(a.category),o.push({id:a.category,name:a.category,color:i[(n.size-1)%i.length]}))}):l==null||l.forEach(a=>{n.has(a.id)||(n.add(a.id),o.push({id:a.id,name:a.chartShowName??a.name,color:i[(n.size-1)%i.length]}))}),o}function getStackColor(e,s){const{basicStyle:o}=parseJson(e.customAttr),{seriesColor:n}=o;if(!(n!=null&&n.length))return;const i=n.reduce((c,f)=>(c[f.id]=f,c),{}),{yAxis:l,extStack:r}=e,{data:a}=s;if(r!=null&&r.length){const c=new Set;a==null||a.forEach(u=>u.category!==null&&c.add(u.category)),[...c].forEach((u,h)=>{const g=i[u];g&&(h+1>o.colors.length?o.colors.push(g.color):o.colors[h]=g.color)})}else l==null||l.forEach((c,f)=>{const u=i[c.id];u&&(f+1>o.colors.length?o.colors.push(u.color):o.colors[f]=u.color)});return o.colors.map(c=>hexColorToRGBA(c,o.alpha))}function setUpStackSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,{yAxis:l,extStack:r}=e;return r!=null&&r.length?s==null||s.forEach(a=>{a.value===null||a.category===null||n.has(a.category)||(n.add(a.category),o.push({id:a.category,name:a.category,color:i[(n.size-1)%i.length]}))}):l==null||l.forEach(a=>{n.has(a.id)||(n.add(a.id),o.push({id:a.id,name:a.chartShowName??a.name,color:i[(n.size-1)%i.length]}))}),o}function getSingleDimensionColor(e,s){const{basicStyle:o}=parseJson(e.customAttr),{seriesColor:n}=o;if(!(n!=null&&n.length))return;const i=n.reduce((c,f)=>(c[f.id]=f,c),{}),{xAxis:l,yAxis:r}=e,{data:a}=s;if(l!=null&&l.length&&(r!=null&&r.length)){const c=new Set;a==null||a.forEach(u=>u.field!==null&&c.add(u.field)),[...c].forEach((u,h)=>{const g=i[u];g&&(h+1>o.colors.length?o.colors.push(g.color):o.colors[h]=g.color)})}return o.colors.map(c=>hexColorToRGBA(c,o.alpha))}function setUpSingleDimensionSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,{xAxis:l,yAxis:r}=e;return l!=null&&l.length&&(r!=null&&r.length)&&(s==null||s.forEach(a=>{n.has(a.field)||(n.add(a.field),o.push({id:a.field,name:a.field,color:i[(n.size-1)%i.length]}))})),o}function isAlphaColor(e){return e!=null&&e.trim()?e.startsWith("#")?e.length===9:e.startsWith("rgb")?e.split(",").length===4:!1:!1}function isTransparent(e){if(!(e!=null&&e.trim()))return!0;if(e.startsWith("#")){const s=e.substring(1,e.length);if(s.length===3||s.length===6)return!1;if(s.length===8)return s.substring(6,8)==="00"}if(e.startsWith("rgb")){const s=e.split(",");return s.length!==4?!1:s[3].substring(0,s[3].length-1).trim()==="0"}return!1}function convertToAlphaColor(e,s){if(!(e!=null&&e.trim()))return"rgba(255,255,255,1)";if(e.startsWith("#")){let o=e.trim().substring(1);if(o.length===3){const i=o.split("");o=`${i[0]}${i[0]}${i[1]}${i[1]}${i[2]}${i[2]}`}if(o.length!==6)return"#FFFFFFFF";const n=parseInt((s*2.55).toFixed(0)).toString(16).toUpperCase();return`#${o}${n}`}return e.startsWith("rgb")?`rgba(${e.match(/\d+/g).join(",")},${s/100})`:"rgba(255,255,255,1)"}function svgStrToUrl(e){let s="";try{if(e){const o=new Blob([e],{type:"image/svg+xml"});s=URL.createObjectURL(o)}}catch{}return s}function filterEmptyMinValue(e,s){let o=0;return getMaxAndMinValueByData(e.filter(n=>n[s]),"value",0,0,(n,i)=>{o=i}),o}export{quotaViews as A,getMapColorCases as B,stepsColor as C,convertToAlphaColor as D,handleEmptyDataStrategy as a,getGroupColor as b,getStackColor as c,getSingleDimensionColor as d,setUpStackSeriesColor as e,flow as f,getColor as g,hexColorToRGBA as h,setUpGroupSeriesColor as i,getGeoJsonFile as j,getMaxAndMinValueByData as k,filterChartDataByRange as l,getDynamicColorScale as m,filterEmptyMinValue as n,svgStrToUrl as o,parseJson as p,setUpSingleDimensionSeriesColor as q,copyString as r,setupSeriesColor as s,resetRgbOpacity as t,useMapStoreWithOut as u,isAlphaColor as v,isTransparent as w,isParent as x,exportExcelDownload as y,getWorldTree as z};
